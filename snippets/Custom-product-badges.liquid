{%- comment -%}
  共通バッジスニペット

  利用パターン：
  1) 一覧・おすすめ・最近見たなど（商品単位）
     → {% render 'Custom-product-badges', badge_product: product %}

  2) カート（line_item のバリアント単位）
     → {% render 'Custom-product-badges', line_item: line_item, context: 'cart' %}

  context:
    - product（デフォルト）
    - cart（カート用：小さいバッジ）
{%- endcomment -%}

{%- liquid
  assign context = context | default: 'product'

  # context == 'cart' の判定
  assign is_cart = false
  if context == 'cart'
    assign is_cart = true
  endif

  # ===== 対象 product / variant の決定 =====
  assign p = nil
  assign v = nil

  if line_item
    # カートなど：line_item から取得
    assign p = line_item.product
    assign v = line_item.variant
  else
    # 従来どおり badge_product または product
    assign p = badge_product | default: product
  endif

  if p == blank or p.id == blank
    assign has_badge = false
  else
    assign now_ts = 'now' | date: '%s' | plus: 0

    ##### --- NEW（product.display_start_at から60日以内：商品単位） ---
    assign is_new = false

    assign display_start_raw = p.metafields.product.display_start_at

    if display_start_raw != blank
      assign new_days  = 60 | plus: 0
      assign days_sec  = new_days | times: 86400
      assign cutoff_ts = now_ts | minus: days_sec

      assign start_ts = display_start_raw | date: '%s' | plus: 0

      if start_ts >= cutoff_ts and start_ts <= now_ts
        assign is_new = true
      endif
    endif

    # ▼ ここから下は、cart かどうかでロジックを分岐
    assign badge_preorder = false
    assign badge_first    = false
    assign badge_early    = false
    assign badge_closing  = false

    if line_item and v
      ##### ▼▼ カート：バリアント単位で判定 ▼▼ #####

      # 予約受付中 → variant.metafields.variant.is_preorder == true
      if v.metafields.variant.is_preorder.value
        assign badge_preorder = true
      endif

      # 初回特典残りわずか → custom.is_first_bonus
      if v.metafields.custom.is_first_bonus.value
        assign badge_first = true
      endif

      # 早期予約特典あり → custom.is_early_bonus
      if v.metafields.custom.is_early_bonus.value
        assign badge_early = true
      endif

      # 締切間近 → sell_end_at が 10 日以内
      assign sell_end_raw = v.metafields.variant.sell_end_at
      if sell_end_raw != blank
        assign end_ts = sell_end_raw | date: '%s' | plus: 0
        assign ten_days_sec    = 10 | times: 86400
        assign closing_from_ts = end_ts | minus: ten_days_sec
        if now_ts >= closing_from_ts and now_ts <= end_ts
          assign badge_closing = true
        endif
      endif

    else
      ##### ▼▼ 一覧・最近見たなど：商品全体で判定 ▼▼ #####

      # 予約受付中（いずれかのバリアント is_preorder=true）
      assign pre_ok = false
      for v2 in p.variants
        if v2.metafields.variant.is_preorder.value
          assign pre_ok = true
          break
        endif
      endfor

      # 初回特典残りわずか
      assign first_bonus_low = false
      for v2 in p.variants
        if v2.metafields.custom.is_first_bonus.value
          assign first_bonus_low = true
          break
        endif
      endfor

      # 早期予約特典あり
      assign early_bonus = false
      for v2 in p.variants
        if v2.metafields.custom.is_early_bonus.value
          assign early_bonus = true
          break
        endif
      endfor

      # 締切間近（全バリアントの sell_end_at の最短）
      assign closing_soon = false
      assign min_end_ts   = 0

      for v2 in p.variants
        assign end_raw = v2.metafields.variant.sell_end_at
        if end_raw != blank
          assign end_ts = end_raw | date: '%s' | plus: 0
          if min_end_ts == 0 or end_ts < min_end_ts
            assign min_end_ts = end_ts
          endif
        endif
      endfor

      if min_end_ts != 0
        assign ten_days_sec     = 10 | times: 86400
        assign closing_from_ts  = min_end_ts | minus: ten_days_sec
        if now_ts >= closing_from_ts and now_ts <= min_end_ts
          assign closing_soon = true
        endif
      endif

      # 一覧側の判定結果を共通変数に反映
      assign badge_preorder = pre_ok
      assign badge_first    = first_bonus_low
      assign badge_early    = early_bonus
      assign badge_closing  = closing_soon
    endif

    assign has_badge = false
    if is_new or badge_preorder or badge_first or badge_early or badge_closing
      assign has_badge = true
    endif
  endif
-%}

{% if has_badge %}
  {%- assign base_class = badge_class | default: 'badge' -%}

  {% if is_new %}
    <span class="{{ base_class }} {{ base_class }}--new">NEW</span>
  {% endif %}

  {% if badge_preorder %}
    <span class="{{ base_class }} {{ base_class }}--pre">予約受付中</span>
  {% endif %}

  {% if badge_early %}
    <span class="{{ base_class }} {{ base_class }}--early">早期予約特典あり</span>
  {% endif %}

  {% if badge_first %}
    <span class="{{ base_class }} {{ base_class }}--first">初回特典残りわずか</span>
  {% endif %}

  {% if badge_closing %}
    <span class="{{ base_class }} {{ base_class }}--closing">締切間近</span>
  {% endif %}
{% endif %}
