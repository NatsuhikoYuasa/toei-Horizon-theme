{% liquid
  assign product_resource = product | default: closest.product
  assign tags_wrap = ',' | append: product_resource.tags | join: ',' | append: ','
  assign tags_lc = product_resource.tags | join: ',' | downcase
  assign template_suffix = product_resource.template_suffix | default: ''
  assign now_ts = 'now' | date: '%s' | plus: 0

  assign pre_ok = false
  if template_suffix contains 'preorder'
    assign pre_ok = true
  elsif tags_wrap contains ',preorder,' or tags_wrap contains ',pre-order,' or tags_wrap contains ',pre order,'
    assign pre_ok = true
  elsif tags_lc contains '予約' or tags_lc contains '先行' or tags_lc contains '先行予約'
    assign pre_ok = true
  elsif product_resource.metafields.custom.preorder
    assign pre_ok = true
  endif

  assign published_ts = product_resource.published_at | date: '%s' | plus: 0
  assign new_threshold = 1209600 | plus: 0
  assign is_new = false
  if published_ts > 0 and now_ts <= published_ts | plus: new_threshold
    assign is_new = true
  endif

  assign first_bonus_total = 0
  assign first_bonus_low = false
  assign early_bonus = false
  assign closing_soon = false
  assign first_bonus_threshold = 10 | plus: 0
  assign ten_days_sec = 864000 | plus: 0
  assign min_end_ts = 0

  for v in product_resource.variants
    assign v_inventory = v.inventory_quantity | default: 0 | plus: 0
    assign v_is_first_bonus = v.metafields.custom.is_first_bonus
    assign v_is_early_bonus = v.metafields.custom.is_early_bonus

    if v_is_first_bonus and v_inventory > 0
      assign first_bonus_total = first_bonus_total | plus: v_inventory
    endif

    if pre_ok and v_is_early_bonus
      assign early_bonus = true
    endif

    assign v_end_raw = v.metafields.variant.sell_end_at
    if v_end_raw != blank
      assign v_end_ts = v_end_raw | date: '%s' | plus: 0
      if min_end_ts == 0 or v_end_ts < min_end_ts
        assign min_end_ts = v_end_ts
      endif
    endif
  endfor

  if first_bonus_total > 0 and first_bonus_total <= first_bonus_threshold
    assign first_bonus_low = true
  endif

  if min_end_ts != 0
    assign closing_from_ts = min_end_ts | minus: ten_days_sec
    if now_ts >= closing_from_ts and now_ts <= min_end_ts
      assign closing_soon = true
    endif
  endif

  assign has_wb_badges = false
  if is_new or pre_ok or first_bonus_low or early_bonus or closing_soon
    assign has_wb_badges = true
  endif
%}

{% if has_wb_badges %}
  <div class="csh-badges csh-badges--product" data-has-wb-badges="{{ has_wb_badges }}">
    {% if is_new and pre_ok == false %}
      <span class="csh-badge csh-badge--new">NEW</span>
    {% endif %}

    {% if pre_ok %}
      <span class="csh-badge csh-badge--pre">予約受付中</span>
    {% endif %}

    {% if first_bonus_low %}
      <span class="csh-badge csh-badge--first-bonus">初回特典残りわずか</span>
    {% endif %}

    {% if early_bonus %}
      <span class="csh-badge csh-badge--early">早期予約特典あり</span>
    {% endif %}

    {% if closing_soon %}
      <span class="csh-badge csh-badge--closing">締切間近</span>
    {% endif %}
  </div>
{% endif %}
