{% comment %}
  Custom-recently-viewed-recorder.liquid
  - 商品ページで最近見た商品を localStorage に保存
  - バッジ判定は商品バッジ（Custom-product-badges）と同じロジック
    * NEW … product.metafields.product.display_start_at から 60 日以内
    * 予約受付中 … いずれかのバリアントの metafields.variant.is_preorder = true
    * 初回特典残りわずか … いずれかのバリアントの metafields.custom.is_first_bonus = true
    * 早期予約特典あり … いずれかのバリアントの metafields.custom.is_early_bonus = true
    * 締切間近 … 各バリアントの metafields.variant.sell_end_at の最短が 10 日以内
{% endcomment %}

{%- liquid
  assign p = product

  assign is_new          = false
  assign pre_ok          = false
  assign first_bonus_low = false
  assign early_bonus     = false
  assign closing_soon    = false

  if p != blank and p.id != blank
    assign now_ts = 'now' | date: '%s' | plus: 0

    ##### --- NEW（display_start_at から 60 日以内） ---
    assign new_days  = 60 | plus: 0
    assign days_sec  = new_days | times: 86400
    assign cutoff_ts = now_ts | minus: days_sec

    assign ds = p.metafields.product.display_start_at
    if ds != blank
      assign ds_ts = ds | date: '%s' | plus: 0
      if ds_ts >= cutoff_ts and ds_ts <= now_ts
        assign is_new = true
      endif
    endif

    ##### --- 予約受付中 ---
    assign pre_ok = false

    ##### --- 初回特典残りわずか ---
    assign first_bonus_low = false

    ##### --- 早期予約特典あり ---
    assign early_bonus = false

    ##### --- 締切間近 ---
    assign closing_soon = false
    assign min_end_ts   = 0

    for v in p.variants
      # 予約商品か
      if v.metafields.variant.is_preorder.value
        assign pre_ok = true
      endif

      # 初回特典あり（※ここでは「残りわずか」までは判定せず、フラグだけ true）
      if v.metafields.custom.is_first_bonus.value
        assign first_bonus_low = true
      endif

      # 早期予約特典あり
      if v.metafields.custom.is_early_bonus.value
        assign early_bonus = true
      endif

      # 締切間近用：sell_end_at の最短
      assign end_raw = v.metafields.variant.sell_end_at
      if end_raw != blank
        assign end_ts = end_raw | date: '%s' | plus: 0
        if min_end_ts == 0 or end_ts < min_end_ts
          assign min_end_ts = end_ts
        endif
      endif
    endfor

    if min_end_ts != 0
      assign ten_days_sec     = 10 | times: 86400
      assign closing_from_ts  = min_end_ts | minus: ten_days_sec
      if now_ts >= closing_from_ts and now_ts <= min_end_ts
        assign closing_soon = true
      endif
    endif
  endif

  # ▼ display_start_at / display_end_at によるロック判定
  assign ds_raw = product.metafields.product.display_start_at
  assign de_raw = product.metafields.product.display_end_at

  assign has_ds = ds_raw != blank
  assign has_de = de_raw != blank
  assign ds_ts = 0
  assign de_ts = 0

  if has_ds
    assign ds_ts = ds_raw | date: '%s' | plus: 0
  endif
  if has_de
    assign de_ts = de_raw | date: '%s' | plus: 0
  endif

  assign display_lock = false
  if has_ds and has_de
    if now_ts < ds_ts or now_ts > de_ts
      assign display_lock = true
    endif
  elsif has_ds
    if now_ts < ds_ts
      assign display_lock = true
    endif
  elsif has_de
    if now_ts > de_ts
      assign display_lock = true
    endif
  endif
-%}

<script>
  (function(){
    try{
      var handle = {{ product.handle | json }};
      if (!handle) return;

      var exKey  = 'recentlyViewedEx';
      var key    = 'recentlyViewed';

      var exArr  = [];
      var simple = [];

      try{ exArr  = JSON.parse(localStorage.getItem(exKey)) || []; }catch(e){}
      try{ simple = JSON.parse(localStorage.getItem(key))   || []; }catch(e){}

      // 既存の同じ handle を削除
      exArr  = exArr.filter(function(x){ return !x || x.handle !== handle; });
      simple = simple.filter(function(h){ return h !== handle; });

      // Liquid で計算した各フラグ
      var locked      = {{ display_lock      | json }};
      var isNew       = {{ is_new           | json }};
      var preOk       = {{ pre_ok           | json }};
      var firstBonus  = {{ first_bonus_low  | json }};
      var earlyBonus  = {{ early_bonus      | json }};
      var closingSoon = {{ closing_soon     | json }};

      console.log('[rv-recorder] handle=%s locked=%s new=%s pre=%s first=%s early=%s closing=%s',
        handle, locked, isNew, preOk, firstBonus, earlyBonus, closingSoon);

      // セクション側で使う情報を保存
      exArr.push({
        handle: {{ product.handle | json }},
        url: {{ product.url | json }},
        title: {{ product.title | json }},
        published_at: {{ product.published_at | date: "%Y-%m-%dT%H:%M:%S%z" | json }},
        price_min: {{ product.price_min | json }},
        compare_at_price_max: {{ product.compare_at_price_max | json }},
        available: {{ product.available | json }},
        image: {{ product.featured_image | image_url: width: 700 | json }},
        display_locked: locked,

        // バッジ用フラグ
        is_new:          isNew,
        pre_ok:          preOk,
        first_bonus_low: firstBonus,
        early_bonus:     earlyBonus,
        closing_soon:    closingSoon
      });

      simple.push(handle);

      // 上限 40 件
      if (exArr.length  > 40) exArr  = exArr.slice(-40);
      if (simple.length > 40) simple = simple.slice(-40);

      localStorage.setItem(exKey, JSON.stringify(exArr));
      localStorage.setItem(key,  JSON.stringify(simple));
    }catch(e){}
  })();
</script>
