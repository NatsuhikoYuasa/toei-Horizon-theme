{%- comment -%}
  クロスセル商品（バリアント単位・Storefront API 不使用版）

  - 対象メタフィールド：variant.cross_sell_variants
    - 型: リスト - 商品バリエーション（list.variant_reference）
    - Liquid 上の値:
      v.metafields.variant.cross_sell_variants.value
      → 各要素が「バリアントオブジェクト」として参照可能

  - 仕組み
    1. Liquid で各バリアントごとにクロスセル候補をカードとして全部描画
    2. .rv-list[data-variant-id="xxx"] ごとにラップしておき、
       JS で現在選択中バリアントに対応するリストだけを表示

  - JS では API 呼び出しは一切行わず、DOM の表示制御だけをする。
{%- endcomment -%}

{%- comment -%}
  まず「一つでもクロスセルが設定されているバリアントがあるか」をチェック。
  なければセクション自体を出さない。
{%- endcomment -%}
{%- assign has_any_cross_sell = false -%}
{%- for v in product.variants -%}
  {%- assign xsell_field = v.metafields.variant.cross_sell_variants -%}
  {%- if xsell_field and xsell_field.value != blank -%}
    {%- assign has_any_cross_sell = true -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- if has_any_cross_sell -%}
  {% comment %} wb03 add start バッジ判定＆販売期間（sell_start_at / sell_end_at）判定用の変数を追加 {% endcomment %}
  {%- liquid
    assign xs_now_ts = 'now' | date: '%s' | plus: 0
    assign xs_ten_days_sec = 864000 | plus: 0
    # 締切間近（10日）
    assign xs_new_days = 60 | plus: 0
    # NEW 60日
    assign xs_new_days_sec = xs_new_days | times: 86400
  -%}
  {% comment %} wb03 add end バッジ判定＆販売期間（sell_start_at / sell_end_at）判定用の変数を追加 {% endcomment %}

  <section
    id="custom-xsell-{{ section.id }}"
    class="rv-section section page-width color-{{ section.settings.color_scheme }}"
    style="
      {% render 'spacing-style', settings: section.settings %}
      --rv-gap-pc: {{ section.settings.card_gap | default: 16 }}px;
      --rv-gap-sp: {{ section.settings.card_gap_mobile | default: 12 }}px;
      --rv-safe-inline: var(--full-page-grid-margin-inline-offset, var(--page-margin-inline-offset, 16px));
      padding-block-start: {{ section.settings['padding-block-start'] | default: 36 }}px;
      padding-block-end:   {{ section.settings['padding-block-end']   | default: 36 }}px;
    "
  >
    <div class="rv-inner">
      <div class="rv-header align-{{ section.settings.heading_align }}">
        <h2 class="rv-title">{{ section.settings.heading | escape }}</h2>
      </div>

      <div class="rv-band" aria-hidden="true"></div>

      {%- comment -%}
        ここで「バリアントごとのクロスセルリスト」を全部描画する。
        data-variant-id で紐付けして、JS 側で表示 / 非表示を切り替える。
      {%- endcomment -%}

      {%- assign current_variant = product.selected_or_first_available_variant -%}

      {%- for v in product.variants -%}
        {%- assign xsell_field = v.metafields.variant.cross_sell_variants -%}
        {%- if xsell_field and xsell_field.value != blank -%}
          {%- assign xsell_variants = xsell_field.value -%}

          <div
            class="rv-list{% if v.id == current_variant.id %} rv-list--active{% endif %}"
            data-variant-id="{{ v.id }}"
            data-limit="{{ section.settings.limit | default: 6 }}"
          >
            {%- comment %} wb03 blocked&add start クロスセル1件分の描画ロジック（元コード） {%- endcomment %}
            {% comment %}
              {%- assign rendered_count = 0 -%}
              {%- for cross_v in xsell_variants -%}
                {%- if rendered_count >= section.settings.limit -%}
                  {%- break -%}
                {%- endif -%}

                {%- assign rendered_count = rendered_count | plus: 1 -%}

                {%- assign cv = cross_v -%}
                {%- assign cv_product = cv.product -%}

                {%- capture card_url -%}
                  {{ cv.url }}
                {%- endcapture -%}

                {%- assign card_url = card_url | strip -%}
                {%- assign card_available = cv.available -%}

                <a
                  class="rv-card{% unless card_available %} rv-card--disabled{% endunless %}"
                  href="{% if card_available %}{{ card_url }}{% else %}javascript:void(0){% endif %}"
                  {% unless card_available %}aria-disabled="true"{% endunless %}
                >
                  <div class="rv-thumb">
                    {%- if cv.image -%}
                      {{ cv.image
                        | image_url: width: 400
                        | image_tag:
                          loading: 'lazy',
                          class: 'rv-img',
                          alt: cv_product.title
                      }}
                    {%- else -%}
                      <span class="rv-thumb__placeholder">NO IMAGE</span>
                    {%- endif -%}
                  </div>

                  <div class="rv-meta">
                    <span class="rv-title-link">
                      {{ cv_product.title }}
                    </span>

                    {%- if section.settings.show_price -%}
                      <span class="rv-price">
                        {{ cv.price | money }}
                      </span>
                    {%- endif -%}
                  </div>
                </a>
              {%- endfor -%}
            {% endcomment %}
            {%- comment %} wb03 blocked&add end クロスセル1件分の描画ロジック（元コード） {%- endcomment %}

            {%- comment %} wb03 add start バッジ＆販売期間＆税込表示ロジック {%- endcomment %}
            {%- assign rendered_count = 0 -%}
            {%- for cross_v in xsell_variants -%}
              {%- assign cv = cross_v -%}
              {%- assign cv_product = cv.product -%}

              {%- liquid
                # -------------------------
                # 表示可否（display_start_at / display_end_at）※商品メタフィールドを見る
                # -------------------------
                assign xs_show = true

                assign xs_display_start_raw = cv_product.metafields.product.display_start_at
                assign xs_display_end_raw = cv_product.metafields.product.display_end_at

                if xs_display_start_raw != blank
                  assign xs_display_start_ts = xs_display_start_raw | date: '%s' | plus: 0
                  if xs_now_ts < xs_display_start_ts
                    assign xs_show = false
                  endif
                endif

                if xs_display_end_raw != blank
                  assign xs_display_end_ts = xs_display_end_raw | date: '%s' | plus: 0
                  if xs_now_ts > xs_display_end_ts
                    assign xs_show = false
                  endif
                endif

                # -------------------------
                # バッジ判定
                # -------------------------
                assign xs_badge_new = false
                assign xs_badge_pre = false
                assign xs_badge_early = false
                assign xs_badge_first = false
                assign xs_badge_closing = false

                # NEW（product.display_start_at から60日間）
                assign xs_display_start_raw_for_new = cv_product.metafields.product.display_start_at
                if xs_display_start_raw_for_new != blank
                  assign xs_start_ts = xs_display_start_raw_for_new | date: '%s' | plus: 0
                  assign xs_new_end_ts = xs_start_ts | plus: xs_new_days_sec
                  if xs_now_ts >= xs_start_ts and xs_now_ts <= xs_new_end_ts
                    assign xs_badge_new = true
                  endif
                endif

                # 予約受付中（バリアントMF）
                if cv.metafields.variant.is_preorder
                  assign xs_badge_pre = true
                endif

                # 初回特典残りわずか（バリアントMF）
                if cv.metafields.custom.is_first_bonus
                  assign xs_badge_first = true
                endif

                # 早期予約特典あり（バリアントMF）
                if cv.metafields.custom.is_early_bonus
                  assign xs_badge_early = true
                endif

                # 締切間近（sell_end_at の10日前〜当日）※こちらは従来どおり sell_end_at を使用
                assign xs_sell_end_raw = cv.metafields.variant.sell_end_at
                if xs_sell_end_raw != blank
                  assign xs_sell_end_ts2 = xs_sell_end_raw | date: '%s' | plus: 0
                  assign xs_closing_from_ts = xs_sell_end_ts2 | minus: xs_ten_days_sec
                  if xs_now_ts >= xs_closing_from_ts and xs_now_ts <= xs_sell_end_ts2
                    assign xs_badge_closing = true
                  endif
                endif
              -%}

              {%- if xs_show -%}
                {%- assign rendered_count = rendered_count | plus: 1 -%}
                {%- if rendered_count > section.settings.limit -%}
                  {%- break -%}
                {%- endif -%}

                {%- capture card_url -%}
                {{ cv.url }}
              {%- endcapture -%}
                {%- assign card_url = card_url | strip -%}
                {%- assign card_available = cv.available -%}

                <a
                  class="rv-card{% unless card_available %} rv-card--disabled{% endunless %}"
                  href="{% if card_available %}{{ card_url }}{% else %}javascript:void(0){% endif %}"
                  {% unless card_available %}
                    aria-disabled="true"
                  {% endunless %}
                >
                  <!-- 画像 -->
                  <div class="rv-thumb csh-thumb">
                    {%- if cv.image -%}
                      {{
                        cv.image
                        | image_url: width: 400
                        | image_tag: loading: 'lazy', class: 'rv-img', alt: cv_product.title
                      }}
                    {%- elsif cv_product.featured_image -%}
                      {{
                        cv_product.featured_image
                        | image_url: width: 400
                        | image_tag: loading: 'lazy', class: 'rv-img', alt: cv_product.title
                      }}
                    {%- else -%}
                      <span class="rv-thumb__placeholder">NO IMAGE</span>
                    {%- endif -%}
                  </div>

                  <!-- バッジ -->
                  <div class="csh-badges csh-badges--below rv-badges">
                    {%- if xs_badge_new -%}
                      <span class="csh-badge csh-badge--new">NEW</span>
                    {%- endif -%}
                    {%- if xs_badge_pre -%}
                      <span class="csh-badge csh-badge--pre">予約受付中</span>
                    {%- endif -%}
                    {%- if xs_badge_early -%}
                      <span class="csh-badge csh-badge--early">早期予約特典あり</span>
                    {%- endif -%}
                    {%- if xs_badge_first -%}
                      <span class="csh-badge csh-badge--first">初回特典残りわずか</span>
                    {%- endif -%}
                    {%- if xs_badge_closing -%}
                      <span class="csh-badge csh-badge--closing">締切間近</span>
                    {%- endif -%}
                  </div>

                  <!-- 本文 -->
                  <div class="csh-body">
                    <div class="csh-name">{{ cv_product.title }}</div>

                    {%- if section.settings.show_price -%}
                      <div class="csh-price">
                        <span class="csh-price-current">{{ cv.price | money }}</span>
                        <span class="csh-price-tax">（税込）</span>
                      </div>
                    {%- endif -%}
                  </div>
                </a>
              {%- endif -%}
            {%- endfor -%}
            {%- comment %} wb03 add end バッジ＆販売期間＆税込表示ロジック {%- endcomment %}
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>

    <style>
      /* ====== 見出し ====== */
      #custom-xsell-{{ section.id }} .rv-header{ margin-bottom:40px; }
      #custom-xsell-{{ section.id }} .rv-header.align-center{ text-align:center; }
      #custom-xsell-{{ section.id }} .rv-title{
        font-size:22px; line-height:1.35; font-weight:700; margin:0;
        border-bottom:1px solid rgba(0,0,0,.1); padding-bottom:24px;
      }
      .color-scheme-2 #custom-xsell-{{ section.id }} .rv-title,
      .color-scheme-3 #custom-xsell-{{ section.id }} .rv-title { border-color: rgba(255,255,255,.12); }

      /* ====== PC：グリッド ====== */
      /* バリアントごとの .rv-list は JS で rv-list--active を付ける前提 */
      #custom-xsell-{{ section.id }} .rv-list{
        display:none; /* デフォルト非表示 */
      }
      #custom-xsell-{{ section.id }} .rv-list.rv-list--active{
        display:grid;
        grid-template-columns: repeat(6, minmax(0,1fr));
        gap: var(--rv-gap-pc);
      }

      /* ====== カード ====== */
      #custom-xsell-{{ section.id }} .rv-card{
        display:flex; flex-direction:column; text-decoration:none; color:inherit;
      }
      #custom-xsell-{{ section.id }} .rv-thumb{
        display:flex; align-items:center; justify-content:center;
        border-radius:5px; overflow:hidden;
      }
      #custom-xsell-{{ section.id }} .rv-img{ width:100%; height:auto; border-radius:5px; display:block; }

      /* グレーアウト & クリック不可 */
      #custom-xsell-{{ section.id }} .rv-card--disabled,
      #custom-xsell-{{ section.id }} .rv-card.rv-locked{
        pointer-events:none;
        opacity:.45;
      }

      /* ▼ バッジ（画像の下） */
      #custom-xsell-{{ section.id }} .rv-badges{
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      #custom-xsell-{{ section.id }} .rv-badges:empty {
        display: none;
        margin-top: 0;
      }

      #custom-xsell-{{ section.id }} .rv-badge{
        font-size:10px; font-weight:700; line-height:1; padding:6px 8px;
        box-shadow:0 1px 2px rgba(0,0,0,.15);
      }

      #custom-xsell-{{ section.id }} .rv-meta{
        padding:8px 12px 10px 0; display:grid; gap:6px;
      }
      #custom-xsell-{{ section.id }} .rv-title-link{
        font-size:13px; line-height:1.4; display:-webkit-box;
        -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; color:inherit;
      }
      #custom-xsell-{{ section.id }} .rv-price{ font-size:12px; opacity:.9; }

      #custom-xsell-{{ section.id }}{ background: {{ section.settings.bg_color | default: '#F5F6F9' }}; }

      #custom-xsell-{{ section.id }} .rv-price-tax{
        font-size:10px;
      }

      /* ====== SP：横スクロール ====== */
      @media (max-width: 768px){
        #custom-xsell-{{ section.id }}{ position:relative; overflow:visible; }
        #custom-xsell-{{ section.id }} .rv-band{
          position:absolute; top:0; bottom:0; right:calc(50% - 50vw);
          width:48px; background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.06));
          pointer-events:none; opacity:0;
        }
        /* SP 時はアクティブな .rv-list を横スクロールに */
        #custom-xsell-{{ section.id }} .rv-list.rv-list--active{
          display:flex !important; gap: var(--rv-gap-sp);
          overflow-x:auto; overflow-y:visible; -webkit-overflow-scrolling:touch;
          scroll-snap-type:x proximity; scroll-snap-stop:normal; scrollbar-gutter:stable;
          scroll-padding-right: var(--rv-safe-inline);
          width: calc(100vw - var(--rv-safe-inline));
          margin-right: calc(50% - 50vw - var(--rv-gap-sp));
        }
        #custom-xsell-{{ section.id }} .rv-list::after{
          content:""; flex: 0 0 calc(max(0px, var(--rv-safe-inline) - var(--rv-gap-sp)));
        }
        #custom-xsell-{{ section.id }} .rv-list::-webkit-scrollbar{ display:none; }
        #custom-xsell-{{ section.id }} .rv-card{
          flex: 0 0 clamp(140px, 38vw, 240px);
          width: clamp(140px, 38vw, 240px);
          scroll-snap-align:start;
        }
        #custom-xsell-{{ section.id }} .rv-title{ font-size:18px; }
      }

      /* バッジの折り返し */
      #custom-xsell-{{ section.id }} .rv-badges{
        display:flex !important;
        flex-wrap:wrap !important;
        gap:6px 6px !important;
      }
      #custom-xsell-{{ section.id }} .rv-badges .rv-badge{
        display:inline-flex !important;
        align-items:center;
        white-space:nowrap !important;
        min-width:max-content;
      }

      .csh-body {
        padding: 8px 12px 10px 0;
      }

      .csh-price-tax {
        font-size: 10px;
      }

      .csh-name {
        font-size:13px;
      }

      .csh-price-current {
        font-size: 12px;
      }
    </style>

    <script>
      (function () {
        var root = document.getElementById('custom-xsell-{{ section.id }}');
        if (!root) return;

        // .rv-list をまとめて取るヘルパー
        function getLists() {
          return root.querySelectorAll('.rv-list');
        }

        // 指定されたバリアントIDに対応する .rv-list を表示
        function showForVariantId(variantId) {
          var lists = getLists();
          if (!lists.length) {
            console.log('[XSell] no .rv-list nodes, hide section');
            root.style.display = 'none';
            return;
          }

          if (!variantId) {
            // variantId が取れないときは 1 つ目だけ表示しておく
            lists.forEach(function (list, index) {
              if (index === 0) {
                list.classList.add('rv-list--active');
              } else {
                list.classList.remove('rv-list--active');
              }
            });
            console.log('[XSell] no variantId, show first list as fallback');
            root.style.display = '';
            return;
          }

          var variantIdStr = String(variantId);
          var found = false;

          lists.forEach(function (list) {
            if (list.dataset.variantId === variantIdStr) {
              list.classList.add('rv-list--active');
              found = true;
            } else {
              list.classList.remove('rv-list--active');
            }
          });

          if (!found) {
            // 対応するリストが無いときはセクションごと消す
            console.log('[XSell] no list for variantId =', variantIdStr, '→ hide section');
            root.style.display = 'none';
          } else {
            console.log('[XSell] show list for variantId =', variantIdStr);
            root.style.display = '';
          }
        }

        // hidden input から現在のバリアントIDを取得（初期表示用フォールバック）
        function getCurrentVariantIdFromInput() {
          var hiddenInput = document.querySelector('[data-toei-variant-id]');
          if (!hiddenInput) return null;
          var v = hiddenInput.value;
          return v ? String(v) : null;
        }

        // 初期表示
        function init() {
          var currentId = getCurrentVariantIdFromInput();
          console.log('[XSell] init: hidden input variantId =', currentId);
          showForVariantId(currentId);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }

        // バリアント変更イベントに追従（メインの切り替えロジック）
        document.addEventListener('variant:changed', function (e) {
          try {
            var detail = (e && e.detail) || {};
            var v = detail.variant || {};
            var id = v.id;

            console.log('[XSell] variant:changed event received. raw id =', id);

            if (!id) return;

            var numericId = String(id);
            // GID 形式 (gid://shopify/ProductVariant/123...) のときは末尾だけ取り出す
            if (numericId.indexOf('/') !== -1) {
              numericId = numericId.split('/').pop();
            }

            console.log('[XSell] normalized variant id =', numericId);

            showForVariantId(numericId);
          } catch (err) {
            console.error('[XSell] variant:changed handler error', err);
          }
        });
      })();
    </script>
  </section>
{%- endif -%}

{% schema %}
{
  "name": "クロスセル商品（バリアント）",
  "settings": [
    { "type": "text", "id": "heading", "label": "見出し", "default": "こちらもおすすめ" },
    {
      "type": "select",
      "id": "heading_align",
      "label": "見出しの揃え",
      "default": "left",
      "options": [
        { "value": "left", "label": "左寄せ" },
        { "value": "center", "label": "中央寄せ" }
      ]
    },
    { "type": "color", "id": "bg_color", "label": "背景色", "default": "#F5F6F9" },
    { "type": "range", "id": "limit", "label": "最大表示数", "min": 1, "max": 12, "step": 1, "default": 6 },
    { "type": "checkbox", "id": "show_price", "label": "価格を表示する", "default": true },

    { "type": "header", "content": "カード間隔" },
    {
      "type": "range",
      "id": "card_gap",
      "label": "（PC）商品カードの間隔 (px)",
      "min": 8,
      "max": 32,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "card_gap_mobile",
      "label": "（スマホ）商品カードの間隔 (px)",
      "min": 6,
      "max": 24,
      "step": 1,
      "default": 12
    },

    { "type": "header", "content": "余白" },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "上余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "下余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },

    { "type": "color_scheme", "id": "color_scheme", "label": "配色（Horizonのスキーム）", "default": "scheme-1" }
  ],
  "presets": [{ "name": "クロスセル商品（Custom）" }],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
