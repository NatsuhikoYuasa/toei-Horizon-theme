{%- comment -%}
  クロスセル商品（バリアント単位）

  - 対象メタフィールド：variant.cross_sell_variants
    - 型: リスト - 商品バリエーション（list.variant_reference）
    - Liquid 上の値: ["gid://shopify/ProductVariant/xxx", ...] 形式の GID 配列
  - 現在選択中のバリアント ID（数値）をキーにして、
    「どの GID のバリアントをクロスセルとして出すか」をマッピングする。
  - バリアントの詳細情報（タイトル / 価格 / 画像 / 商品ハンドルなど）は
    Storefront API (GraphQL) で GID から取得する。

  連携ポイント：
  - sections/Custom-product-information-toei.liquid 内の JS が
    `document.dispatchEvent(new CustomEvent('variant:changed', { detail: { variant: { id, featured_media }}}))`
    を発火しているので、このイベントに合わせて内容を更新する。
{%- endcomment -%}

<section
  id="custom-xsell-{{ section.id }}"
  class="rv-section section page-width color-{{ section.settings.color_scheme }}"
  style="
    {% render 'spacing-style', settings: section.settings %}
    --rv-gap-pc: {{ section.settings.card_gap | default: 16 }}px;
    --rv-gap-sp: {{ section.settings.card_gap_mobile | default: 12 }}px;
    --rv-safe-inline: var(--full-page-grid-margin-inline-offset, var(--page-margin-inline-offset, 16px));
    padding-block-start: {{ section.settings['padding-block-start'] | default: 36 }}px;
    padding-block-end:   {{ section.settings['padding-block-end']   | default: 36 }}px;
  "
>
  <div class="rv-inner">
    <div class="rv-header align-{{ section.settings.heading_align }}">
      <h2 class="rv-title">{{ section.settings.heading | escape }}</h2>
    </div>

    <div class="rv-band" aria-hidden="true"></div>

    <div class="rv-list" data-limit="{{ section.settings.limit | default: 6 }}">
      {%- comment -%} JS でクロスセル商品カードを挿入 {%- endcomment -%}
    </div>
  </div>

  <style>
    /* ====== 見出し ====== */
    #custom-xsell-{{ section.id }} .rv-header{ margin-bottom:16px; }
    #custom-xsell-{{ section.id }} .rv-header.align-center{ text-align:center; }
    #custom-xsell-{{ section.id }} .rv-title{
      font-size:22px; line-height:1.35; font-weight:700; margin:0;
      border-bottom:1px solid rgba(0,0,0,.1); padding-bottom:10px;
    }
    .color-scheme-2 #custom-xsell-{{ section.id }} .rv-title,
    .color-scheme-3 #custom-xsell-{{ section.id }} .rv-title { border-color: rgba(255,255,255,.12); }

    /* ====== PC：グリッド ====== */
    #custom-xsell-{{ section.id }} .rv-list{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: var(--rv-gap-pc);
    }

    /* ====== カード ====== */
    #custom-xsell-{{ section.id }} .rv-card{
      display:flex; flex-direction:column; text-decoration:none; color:inherit;
    }
    #custom-xsell-{{ section.id }} .rv-thumb{
      display:flex; align-items:center; justify-content:center;
      border-radius:5px; overflow:hidden;
    }
    #custom-xsell-{{ section.id }} .rv-img{ width:100%; height:auto; border-radius:5px; display:block; }

    /* グレーアウト & クリック不可 */
    #custom-xsell-{{ section.id }} .rv-card--disabled{
      pointer-events:none;
      opacity:.45;
    }

    /* ▼ バッジ（今は未使用だが、今後の拡張用） */
    #custom-xsell-{{ section.id }} .rv-badges{
      display:flex; gap:6px; margin-top:8px;
    }
    #custom-xsell-{{ section.id }} .rv-badge{
      font-size:10px; font-weight:700; line-height:1; padding:6px 8px;
      box-shadow:0 1px 2px rgba(0,0,0,.15);
    }

    #custom-xsell-{{ section.id }} .rv-meta{
      padding:8px 12px 10px 0; display:grid; gap:6px;
    }
    #custom-xsell-{{ section.id }} .rv-title-link{
      font-size:13px; line-height:1.4; display:-webkit-box;
      -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; color:inherit;
    }
    #custom-xsell-{{ section.id }} .rv-price{ font-size:12px; opacity:.9; }

    #custom-xsell-{{ section.id }}{ background: {{ section.settings.bg_color | default: '#F5F6F9' }}; }

    /* ====== SP：横スクロール ====== */
    @media (max-width: 768px){
      #custom-xsell-{{ section.id }}{ position:relative; overflow:visible; }
      #custom-xsell-{{ section.id }} .rv-band{
        position:absolute; top:0; bottom:0; right:calc(50% - 50vw);
        width:48px; background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.06));
        pointer-events:none; opacity:0;
      }
      #custom-xsell-{{ section.id }} .rv-list{
        display:flex !important; gap: var(--rv-gap-sp);
        overflow-x:auto; overflow-y:visible; -webkit-overflow-scrolling:touch;
        scroll-snap-type:x proximity; scroll-snap-stop:normal; scrollbar-gutter:stable;
        scroll-padding-right: var(--rv-safe-inline);
        width: calc(100vw - var(--rv-safe-inline));
        margin-right: calc(50% - 50vw - var(--rv-gap-sp));
      }
      #custom-xsell-{{ section.id }} .rv-list::after{
        content:""; flex: 0 0 calc(max(0px, var(--rv-safe-inline) - var(--rv-gap-sp)));
      }
      #custom-xsell-{{ section.id }} .rv-list::-webkit-scrollbar{ display:none; }
      #custom-xsell-{{ section.id }} .rv-card{
        flex: 0 0 clamp(140px, 38vw, 240px);
        width: clamp(140px, 38vw, 240px);
        scroll-snap-align:start;
      }
      #custom-xsell-{{ section.id }} .rv-title{ font-size:18px; }
    }

    /* バッジの折り返し */
    #custom-xsell-{{ section.id }} .rv-badges{
      display:flex !important;
      flex-wrap:wrap !important;
      gap:6px 6px !important;
    }
    #custom-xsell-{{ section.id }} .rv-badges .rv-badge{
      display:inline-flex !important;
      align-items:center;
      white-space:nowrap !important;
      min-width:max-content;
    }
  </style>

  {%- comment -%}
    Liquid 側で「バリアント ID（数値）」→「クロスセル対象の GID 配列」のマップを JSON として用意する。

    例：
    {
      "48179227558131": ["gid://shopify/ProductVariant/47910737871091", ...],
      "48179227590899": ["gid://shopify/ProductVariant/48108020138227", ...]
    }
  {%- endcomment -%}
  {%- capture cross_sell_map -%}
  {
  {%- assign variant_delimiter = '' -%}
  {%- for v in product.variants -%}
    {%- assign cs_raw = v.metafields.variant.cross_sell_variants -%}
    {%- if cs_raw != blank -%}
      {{- variant_delimiter }}"{{ v.id }}": {{ cs_raw | json }}
      {%- assign variant_delimiter = ',' -%}
    {%- endif -%}
  {%- endfor -%}
  }
  {%- endcapture -%}
  {%- assign cross_sell_map = cross_sell_map | strip_newlines | strip -%}

  <script>
    (function(){
      var root = document.getElementById('custom-xsell-{{ section.id }}');
      if (!root) return;

      var listEl = root.querySelector('.rv-list');
      if (!listEl) return;

      var limit = parseInt(listEl.dataset.limit || '6', 10);
      var showPrice = {{ section.settings.show_price | default: true | json }};
      var STORE_TOKEN = {{ section.settings.storefront_token | json }};

      // Liquid から埋め込んだ「variant.id → GID 配列」のマップ
      var CROSS_SELL_MAP = {{ cross_sell_map }};

      // Storefront API のトークンが未設定なら何もしない
      if (!STORE_TOKEN) {
        root.style.display = 'none';
        return;
      }

      function clearList(){
        while (listEl.firstChild) {
          listEl.removeChild(listEl.firstChild);
        }
      }

      function formatPrice(amount, currencyCode){
        var n = Number(amount || 0);
        if (!isFinite(n)) return '';
        try{
          return new Intl.NumberFormat('ja-JP', {
            style: 'currency',
            currency: currencyCode || 'JPY'
          }).format(n);
        }catch(e){
          return (currencyCode || 'JPY') + ' ' + n.toFixed(0);
        }
      }

      function renderFromNodes(nodes){
        clearList();

        if (!nodes || !nodes.length) {
          root.style.display = 'none';
          return;
        }

        var rendered = 0;
        var seenProducts = {};

        nodes.forEach(function(node){
          if (!node || rendered >= limit) return;

          var product = node.product || {};
          var productId = product.id || null;

          if (productId && seenProducts[productId]) {
            return;
          }
          if (productId) {
            seenProducts[productId] = true;
          }

          var variantGid = node.id || '';
          var variantIdSimple = variantGid.split('/').pop();

          var title = product.title || node.title || '';
          if (!title) return;

          var available = (node.availableForSale !== false);

          var image = node.image || {};
          var imgUrl = image.url || null;
          var imgAlt = image.altText || title;

          var priceObj = node.price || {};
          var amount = priceObj.amount;
          var currencyCode = priceObj.currencyCode || 'JPY';

          var url = '#';
          if (product.onlineStoreUrl) {
            url = product.onlineStoreUrl;
            if (variantIdSimple) {
              if (url.indexOf('?') === -1) {
                url += '?variant=' + encodeURIComponent(variantIdSimple);
              } else {
                url += '&variant=' + encodeURIComponent(variantIdSimple);
              }
            }
          } else if (product.handle) {
            url = '/products/' + product.handle;
            if (variantIdSimple) {
              url += '?variant=' + encodeURIComponent(variantIdSimple);
            }
          }

          var card = document.createElement('a');
          card.className = 'rv-card';
          if (!available) {
            card.classList.add('rv-card--disabled');
            card.setAttribute('aria-disabled', 'true');
            card.href = 'javascript:void(0)';
          } else {
            card.href = url;
          }

          var thumb = document.createElement('div');
          thumb.className = 'rv-thumb';
          if (imgUrl) {
            var img = document.createElement('img');
            img.className = 'rv-img';
            img.src = imgUrl;
            img.alt = imgAlt;
            thumb.appendChild(img);
          } else {
            var placeholder = document.createElement('span');
            placeholder.className = 'rv-thumb__placeholder';
            placeholder.textContent = 'NO IMAGE';
            thumb.appendChild(placeholder);
          }

          var meta = document.createElement('div');
          meta.className = 'rv-meta';

          var titleEl = document.createElement('span');
          titleEl.className = 'rv-title-link';
          titleEl.textContent = title;
          meta.appendChild(titleEl);

          if (showPrice && typeof amount !== 'undefined' && amount !== null) {
            var priceEl = document.createElement('span');
            priceEl.className = 'rv-price';
            priceEl.textContent = formatPrice(amount, currencyCode);
            meta.appendChild(priceEl);
          }

          card.appendChild(thumb);
          card.appendChild(meta);

          listEl.appendChild(card);
          rendered += 1;
        });

        if (!rendered) {
          root.style.display = 'none';
        } else {
          root.style.display = '';
        }
      }

      var lastRequestKey = null;
      var inFlight = null;

      function fetchAndRenderByGids(gids){
        if (!gids || !gids.length) {
          clearList();
          root.style.display = 'none';
          return;
        }

        var dedup = {};
        var unique = [];
        gids.forEach(function(gid){
          if (!gid) return;
          if (dedup[gid]) return;
          dedup[gid] = true;
          unique.push(gid);
        });

        if (!unique.length) {
          clearList();
          root.style.display = 'none';
          return;
        }

        var key = unique.join(',');
        if (key === lastRequestKey && inFlight) {
          return;
        }
        lastRequestKey = key;

        var endpoint = '/api/2024-01/graphql.json';
        var query = `
          query CrossSellVariants($ids: [ID!]!) {
            nodes(ids: $ids) {
              ... on ProductVariant {
                id
                title
                availableForSale
                price: priceV2 {
                  amount
                  currencyCode
                }
                image {
                  url
                  altText
                }
                product {
                  id
                  handle
                  title
                  onlineStoreUrl
                }
              }
            }
          }
        `;

        inFlight = fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-Shopify-Storefront-Access-Token': STORE_TOKEN
          },
          body: JSON.stringify({
            query: query,
            variables: { ids: unique }
          })
        })
          .then(function(res){ return res.json(); })
          .then(function(resJson){
            inFlight = null;
            var nodes = (resJson && resJson.data && resJson.data.nodes) || [];
            renderFromNodes(nodes);
          })
          .catch(function(err){
            console.error('[cross-sell variants] Storefront API error', err);
            inFlight = null;
            clearList();
            root.style.display = 'none';
          });
      }

      function updateForVariantId(variantId){
        if (!variantId) {
          clearList();
          root.style.display = 'none';
          return;
        }
        var key = String(variantId);
        var gids = CROSS_SELL_MAP && CROSS_SELL_MAP[key];
        if (!gids || !gids.length) {
          clearList();
          root.style.display = 'none';
          return;
        }
        fetchAndRenderByGids(gids);
      }

      function initFirstRender(){
        try{
          var hiddenInput = document.querySelector('[data-toei-variant-id]');
          var currentId = hiddenInput && hiddenInput.value;
          if (currentId) {
            updateForVariantId(currentId);
          } else {
            root.style.display = 'none';
          }
        }catch(e){
          root.style.display = 'none';
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFirstRender);
      } else {
        initFirstRender();
      }

      document.addEventListener('variant:changed', function(e){
        try{
          var detail = e && e.detail || {};
          var v = detail.variant || {};
          var id = v.id;
          if (!id) return;
          var numericId = String(id);
          if (numericId.indexOf('/') !== -1) {
            numericId = numericId.split('/').pop();
          }
          updateForVariantId(numericId);
        }catch(err){}
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "クロスセル商品（バリアント）",
  "settings": [
    { "type": "text", "id": "heading", "label": "見出し", "default": "こちらもおすすめ" },
    {
      "type": "select",
      "id": "heading_align",
      "label": "見出しの揃え",
      "default": "left",
      "options": [
        { "value": "left", "label": "左寄せ" },
        { "value": "center", "label": "中央寄せ" }
      ]
    },
    { "type": "color", "id": "bg_color", "label": "背景色", "default": "#F5F6F9" },
    { "type": "range", "id": "limit", "label": "最大表示数", "min": 1, "max": 12, "step": 1, "default": 6 },
    { "type": "checkbox", "id": "show_price", "label": "価格を表示する", "default": true },

    { "type": "header", "content": "カード間隔" },
    {
      "type": "range",
      "id": "card_gap",
      "label": "（PC）商品カードの間隔 (px)",
      "min": 8,
      "max": 32,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "card_gap_mobile",
      "label": "（スマホ）商品カードの間隔 (px)",
      "min": 6,
      "max": 24,
      "step": 1,
      "default": 12
    },

    { "type": "header", "content": "余白" },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "上余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "下余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },

    { "type": "header", "content": "Storefront API" },
    {
      "type": "text",
      "id": "storefront_token",
      "label": "Storefront API アクセストークン（必須）",
      "info": "管理画面「アプリと販売チャネル」→「開発用ストアフロント API トークン」で発行したトークンを入力してください。",
      "default": "YOUR_STOREFRONT_API_TOKEN"
    },

    { "type": "color_scheme", "id": "color_scheme", "label": "配色（Horizonのスキーム）", "default": "scheme-1" }
  ],
  "presets": [
    { "name": "クロスセル商品（Custom）" }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
