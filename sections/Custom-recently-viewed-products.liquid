{%- comment -%}
  最近見た商品（Custom）
  - localStorage('recentlyViewedEx') に保存された拡張情報をもとに描画
  - バッジ仕様：
      NEW … 公開日が設定日数以内
      予約受付中 … テンプレート/タグ/custom.preorder いずれかで PRE-ORDER 判定
      初回特典残りわずか … 各バリアントの custom.is_first_bonus が true の在庫合計が 10 個以下
      早期予約特典あり … 上記の予約商品かつ、custom.is_early_bonus が true のバリアントが存在
      締切間近 … 各バリアントの variant.sell_end_at の最短が 10 日以内
{%- endcomment -%}
<section
  id="custom-rv-{{ section.id }}"
  class="rv-section section page-width color-{{ section.settings.color_scheme }}"
  style="
    {% render 'spacing-style', settings: section.settings %}
    --rv-gap-pc: {{ section.settings.card_gap | default: 16 }}px;
    --rv-gap-sp: {{ section.settings.card_gap_mobile | default: 12 }}px;
    --rv-safe-inline: var(--full-page-grid-margin-inline-offset, var(--page-margin-inline-offset, 16px));
    padding-block-start: {{ section.settings['padding-block-start'] | default: 36 }}px;
    padding-block-end:   {{ section.settings['padding-block-end']   | default: 36 }}px;
  "
>
  <div class="rv-inner">
    <div class="rv-header align-{{ section.settings.heading_align }}">
      <h2 class="rv-title">{{ section.settings.heading | escape }}</h2>
    </div>

    <div class="rv-band" aria-hidden="true"></div>

    <div class="rv-list" data-limit="{{ section.settings.limit | default: 6 }}">
     {% comment %} JSでカードを挿入 {% endcomment %}
    </div>
  </div>

  <style>
    /* ====== 見出し ====== */
    #custom-rv-{{ section.id }} .rv-header{ margin-bottom:16px; }
    #custom-rv-{{ section.id }} .rv-header.align-center{ text-align:center; }
    #custom-rv-{{ section.id }} .rv-title{
      font-size:22px; line-height:1.35; font-weight:700; margin:0;
      border-bottom:1px solid rgba(0,0,0,.1); padding-bottom:10px;
    }
    .color-scheme-2 #custom-rv-{{ section.id }} .rv-title,
    .color-scheme-3 #custom-rv-{{ section.id }} .rv-title { border-color: rgba(255,255,255,.12); }

    /* ====== PC：グリッド ====== */
    #custom-rv-{{ section.id }} .rv-list{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: var(--rv-gap-pc);
    }

    /* ====== カード ====== */
    #custom-rv-{{ section.id }} .rv-card{
      display:flex; flex-direction:column; text-decoration:none; color:inherit;
    }
    #custom-rv-{{ section.id }} .rv-thumb{
      display:flex; align-items:center; justify-content:center;
      border-radius:5px; overflow:hidden;
    }
    #custom-rv-{{ section.id }} .rv-img{ width:100%; height:auto; border-radius:5px; display:block; }

    /* グレーアウト & クリック不可 */
    #custom-rv-{{ section.id }} .rv-card--disabled,
    #custom-rv-{{ section.id }} .rv-card.rv-locked{
      pointer-events:none;
      opacity:.45;
    }

    /* ▼ バッジ（画像の下） */
    #custom-rv-{{ section.id }} .rv-badges{
      display:flex; gap:6px; margin-top:8px;
    }
    #custom-rv-{{ section.id }} .rv-badge{
      font-size:10px; font-weight:700; line-height:1; padding:6px 8px;
      box-shadow:0 1px 2px rgba(0,0,0,.15);
    }

    #custom-rv-{{ section.id }} .rv-meta{
      padding:8px 12px 10px 0; display:grid; gap:6px;
    }
    #custom-rv-{{ section.id }} .rv-title-link{
      font-size:13px; line-height:1.4; display:-webkit-box;
      -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; color:inherit;
    }
    #custom-rv-{{ section.id }} .rv-price{ font-size:12px; opacity:.9; }

    #custom-rv-{{ section.id }}{ background: {{ section.settings.bg_color | default: '#F5F6F9' }}; }

    #custom-rv-{{ section.id }} .rv-price-tax{
      font-size:10px;
    }
    /* ====== SP：横スクロール ====== */
    @media (max-width: 768px){
      #custom-rv-{{ section.id }}{ position:relative; overflow:visible; }
      #custom-rv-{{ section.id }} .rv-band{
        position:absolute; top:0; bottom:0; right:calc(50% - 50vw);
        width:48px; background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.06));
        pointer-events:none; opacity:0;
      }
      #custom-rv-{{ section.id }} .rv-list{
        display:flex !important; gap: var(--rv-gap-sp);
        overflow-x:auto; overflow-y:visible; -webkit-overflow-scrolling:touch;
        scroll-snap-type:x proximity; scroll-snap-stop:normal; scrollbar-gutter:stable;
        scroll-padding-right: var(--rv-safe-inline);
        width: calc(100vw - var(--rv-safe-inline));
        margin-right: calc(50% - 50vw - var(--rv-gap-sp));
      }
      #custom-rv-{{ section.id }} .rv-list::after{
        content:""; flex: 0 0 calc(max(0px, var(--rv-safe-inline) - var(--rv-gap-sp)));
      }
      #custom-rv-{{ section.id }} .rv-list::-webkit-scrollbar{ display:none; }
      #custom-rv-{{ section.id }} .rv-card{
        flex: 0 0 clamp(140px, 38vw, 240px);
        width: clamp(140px, 38vw, 240px);
        scroll-snap-align:start;
      }
      #custom-rv-{{ section.id }} .rv-title{ font-size:18px; }
    }

    /* バッジの折り返し */
    #custom-rv-{{ section.id }} .rv-badges{
      display:flex !important;
      flex-wrap:wrap !important;
      gap:6px 6px !important;
    }
    #custom-rv-{{ section.id }} .rv-badges .rv-badge{
      display:inline-flex !important;
      align-items:center;
      white-space:nowrap !important;
      min-width:max-content;
    }
  </style>

  <script>
    (function(){
      var root = document.getElementById('custom-rv-{{ section.id }}');
      if (!root) return;

      var listEl = root.querySelector('.rv-list');
      var limit  = parseInt(listEl?.dataset.limit || '6', 10);

      // 1) localStorage から拡張版履歴を取得
      var exArr = [];
      var simpleArr = [];
      try { exArr     = JSON.parse(localStorage.getItem('recentlyViewedEx')) || []; } catch(e){}
      try { simpleArr = JSON.parse(localStorage.getItem('recentlyViewed'))   || []; } catch(e){}

      // 拡張版があればそれを優先（なければ simple のみ → その場合は非表示）
      var source = exArr.length ? exArr : [];
      if (!source.length){
        root.remove();
        return;
      }

      // 直近から重複除去して limit まで抽出
      var picked = [];
      var seen   = {};
      for (var i = source.length - 1; i >= 0 && picked.length < limit; i--){
        var p = source[i];
        var h = p && p.handle;
        if (!h || seen[h]) continue;

        // ★ display_locked（truthy）な商品は「そもそも表示対象にしない」
        var locked = !!p.display_locked;
        if (locked) continue;
        
        seen[h] = 1;
        picked.push(p);
      }
      if (!picked.length){
        root.remove();
        return;
      }

      // いったん中身リセット
      listEl.innerHTML = '';

      // util
      function formatMoney(cents){
        try{
          if (window.Shopify && Shopify.formatMoney) {
            return Shopify.formatMoney(cents, "{{ shop.money_format | replace: '"', '\"' }}");
          }
        }catch(e){}
        var yen = Math.round((cents || 0)/100);
        return new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(yen);
      }

      var NEW_DAYS    = {{ section.settings.new_days    | default: 14   | json }};
      var SHOW_BADGES = {{ section.settings.show_badges | default: true | json }};
      var SHOW_PRICE  = {{ section.settings.show_price  | default: true | json }};

      function normTags(p){
        var t = p && p.tags;
        if (!t) return [];
        if (Array.isArray(t)) return t.map(function(s){ return (s||'').toString(); });
        return t.toString().split(',').map(function(s){ return s.trim(); });
      }
      function hasTag(p, needles){
        var set = normTags(p).map(function(s){ return s.toLowerCase(); });
        return needles.some(function(n){
          n = n.toLowerCase();
          return set.some(function(tag){ return tag === n || tag.indexOf(n) >= 0; });
        });
      }
      function suffixIncl(p, kw){
        var s = (p && p.template_suffix || '').toString().toLowerCase();
        return !!kw && s.indexOf(kw) >= 0;
      }
      function metaTruthy(v){
        if (v == null) return false;
        if (typeof v === 'boolean') return v;
        var s = (''+v).trim().toLowerCase();
        return !!s && s !== '0' && s !== 'false' && s !== 'no' && s !== 'null' && s !== 'undefined';
      }

      function isSale(p){
        try{
          var priceMin = Number(p && p.price_min || 0);
          var capMax   = Number(p && p.compare_at_price_max || 0);
          return capMax > priceMin && priceMin > 0;
        }catch(e){}
        return false;
      }
      function isAvailable(p){
        return !!(p && p.available);
      }
      function isNew(p){
        try{
          var pub = p && p.published_at;
          var ts = pub ? Date.parse(pub) : NaN;
          if (isNaN(ts)) return false;
          var cutoff = Date.now() - NEW_DAYS * 86400000;
          return ts > cutoff;
        }catch(e){}
        return false;
      }
      function isPreorder(p){
        return metaTruthy(p?.metafields?.custom?.preorder)
            || suffixIncl(p,'preorder')
            || hasTag(p, ['preorder','pre-order','pre order','予約','予約販売','先行','先行予約']);
      }
      function isComingSoon(p){
        return metaTruthy(p?.metafields?.custom?.comingsoon)
            || suffixIncl(p,'coming')
            || hasTag(p, ['comingsoon','coming-soon','coming soon','coming_soon','発売前','近日','近日発売','coming']);
      }

      // ▼ 初回特典合計 / 早期予約特典 / 締切間近（recorder で保存した値を利用）
      function getFirstBonusTotal(p){
        try{
          return Number(p && p.first_bonus_total || 0);
        }catch(e){}
        return 0;
      }
      function hasEarlyBonus(p){
        return !!(p && p.early_bonus);
      }
      function isClosingSoon(p){
        return !!(p && p.closing_soon);
      }

            // 2) カード描画
            picked.forEach(function(p){
        if (!p || !p.title) return;

        // ---- バッジ用フラグを統一して計算 ----
        // NEW：まず recorder で保存した is_new を使う
        var bNew;
        if (typeof p.is_new !== 'undefined') {
          bNew = !!p.is_new;
        } else {
          // 旧データ用フォールバック（published_at ＋ NEW_DAYS）
          bNew = false;
          try {
            var pub = p.published_at;
            if (pub) {
              var pubTs  = Date.parse(pub);
              var cutoff = Date.now() - NEW_DAYS * 86400000;
              if (!isNaN(pubTs) && pubTs >= cutoff && pubTs <= Date.now()) {
                bNew = true;
              }
            }
          } catch(e) {}
        }

        // 初回特典：新形式(first_bonus_low) があればそれを優先、
        // なければ first_bonus_total>0 を見る（将来用のフォールバック）
        var bFirst;
        if (typeof p.first_bonus_low !== 'undefined') {
          bFirst = !!p.first_bonus_low;
        } else {
          bFirst = !!(p.first_bonus_total && Number(p.first_bonus_total) > 0);
        }

        // 早期予約特典 / 締切間近
        var bEarly   = !!p.early_bonus;
        var bClosing = !!p.closing_soon;

        // 予約受付中：
        // 1) 新形式の pre_ok があればそれを使う
        // 2) なければ「初回特典・早期特典・締切間近」のいずれかが立っていれば予約とみなす
        var bPre;
        if (typeof p.pre_ok !== 'undefined') {
          bPre = !!p.pre_ok;
        } else {
          bPre = !!(bFirst || bEarly || bClosing);
        }

        // ---- HTML生成 ----
        var badges = '';
        if (SHOW_BADGES && (bNew || bPre || bFirst || bEarly || bClosing)) {
          badges =
            '<div class="rv-badges">'
            + (bNew     ? '<span class="rv-badge rv-badge--new">NEW</span>' : '')
            + (bPre     ? '<span class="rv-badge rv-badge--pre">予約受付中</span>' : '')
            + (bEarly   ? '<span class="rv-badge rv-badge--early">早期予約特典あり</span>' : '')
            + (bFirst   ? '<span class="rv-badge rv-badge--first">初回特典残りわずか</span>' : '')
            + (bClosing ? '<span class="rv-badge rv-badge--closing">締切間近</span>' : '')
            + '</div>';
        }

        // （この下の el の生成〜 appendChild までは現状のまま使ってOK）

        var el = document.createElement('a');
        el.className = 'rv-card';

        // display_locked の反映
        var locked = !!p.display_locked;
        if (locked){
          el.classList.add('rv-locked');
          el.setAttribute('aria-disabled','true');
          el.href = 'javascript:void(0)';
        }else{
          el.href = p.url || ('/products/' + (p.handle || ''));
        }

        // 画像あり・なしに関わらず必ず rv-thumb を出す
        var imgHtml =
          '<div class="rv-thumb">'
          + (p.image
              ? '<img class="rv-img" src="'+ p.image +'" alt="'+ (p.title || '') +'">'
              : '<span class="rv-thumb__placeholder">NO IMAGE</span>')
          + '</div>';

        // ---- 価格表示（セール価格・範囲・税込 の表記を他セクションと合わせる）----
        var priceHtml = '';
        if (SHOW_PRICE) {
          var priceMin   = Number(p && p.price_min || 0);
          var priceMax   = Number(p && p.price_max || 0);
          var compareMax = Number(p && p.compare_at_price_max || 0);
          var hasSale    = compareMax > priceMin && priceMin > 0;

          if (hasSale) {
            // セール中：現在価格＋取り消し線付きの元値
            priceHtml =
              '<div class="rv-price">'
              +   '<span class="rv-price-current">' + formatMoney(priceMin) + '</span>'
              +   '<span class="rv-price-compare"><s>' + formatMoney(compareMax) + '</s></span>'
              +   '<span class="rv-price-tax">（税込）</span>'
              + '</div>';
          } else {
            // 通常価格：バリアントで価格差があれば「〜」表記
            var mainPrice;
            if (priceMin > 0 && priceMax > 0 && priceMin !== priceMax) {
              mainPrice = formatMoney(priceMin) + ' — ' + formatMoney(priceMax);
            } else {
              mainPrice = formatMoney(priceMin || priceMax || 0);
            }

            priceHtml =
              '<div class="rv-price">'
              +   '<span class="rv-price-current">' + mainPrice + '</span>'
              +   '<span class="rv-price-tax">（税込）</span>'
              + '</div>';
          }
        }

        el.innerHTML =
          imgHtml
          + badges
          + '<div class="rv-meta">'
          +   '<span class="rv-title-link">'+ (p.title || '') +'</span>'
          +   priceHtml
          + '</div>';

        listEl.appendChild(el);
      });

      if (!listEl.querySelector('.rv-card')){
        root.remove();
      }
    })();
  </script>
</section>

{% schema %}
{
  "name": "最近見た商品（Custom）",
  "settings": [
    { "type": "text", "id": "heading", "label": "見出し", "default": "最近見た商品" },
    {
      "type": "select",
      "id": "heading_align",
      "label": "見出しの揃え",
      "default": "left",
      "options": [
        { "value": "left", "label": "左寄せ" },
        { "value": "center", "label": "中央寄せ" }
      ]
    },
    { "type": "color", "id": "bg_color", "label": "背景色", "default": "#F5F6F9" },
    { "type": "range", "id": "limit", "label": "最大表示数", "min": 1, "max": 12, "step": 1, "default": 6 },
    { "type": "checkbox", "id": "show_price", "label": "価格を表示する", "default": true },

    { "type": "header", "content": "カード間隔" },
    {
      "type": "range",
      "id": "card_gap",
      "label": "（PC）商品カードの間隔 (px)",
      "min": 8,
      "max": 32,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "card_gap_mobile",
      "label": "（スマホ）商品カードの間隔 (px)",
      "min": 6,
      "max": 24,
      "step": 1,
      "default": 12
    },

    { "type": "header", "content": "余白" },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "上余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "下余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },

    { "type": "header", "content": "バッジ" },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "商品ラベル（NEW / 予約受付中 / 初回特典残りわずか / 早期予約特典あり / 締切間近）を表示",
      "default": true
    },
    { "type": "color_scheme", "id": "color_scheme", "label": "配色（Horizonのスキーム）", "default": "scheme-1" }
  ],
  "presets": [{ "name": "最近見た商品（Custom）" }]
}
{% endschema %}
