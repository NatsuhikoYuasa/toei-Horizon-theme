{% assign the_collection = section.settings.collection %}

<section
  id="csh-{{ section.id }}"
  class="csh section page-width color-{{ section.settings.color_scheme }}"
  style="
    {% render 'spacing-style', settings: section.settings %}
    --csh-gap-pc: {{ section.settings.gap_pc | default: 16 }}px;
    --csh-gap-sp: {{ section.settings.gap_sp | default: 12 }}px;
    --csh-safe: var(--full-page-grid-margin-inline-offset, var(--page-margin-inline-offset, 16px));
    --csh-accent: {{ section.settings.accent_color | default: '#E63946' }};
    padding-block-start: {{ section.settings['padding-block-start'] | default: 36 }}px;
    padding-block-end:   {{ section.settings['padding-block-end']   | default: 36 }}px;
    {% if section.settings.bg_color != blank %}background: {{ section.settings.bg_color }};{% endif %}
  "
>
  {% if the_collection %}
    <div class="csh-head">
      <h2 class="csh-title">{{ the_collection.title }}</h2>
      <a class="csh-more" href="{{ the_collection.url }}" aria-label="{{ the_collection.title }}をもっと見る">
        <span class="csh-more-text">{{ the_collection.title }}をもっと見る</span>
        <span class="csh-more-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
            <path d="M8 5l7 7-7 7" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </a>
    </div>

    {% if the_collection.products_count > 0 %}
      <div class="csh-grid">
        {% for product in the_collection.products limit: section.settings.limit %}

          {%- comment -%} display_start_at / display_end_at による表示ロック判定 {%- endcomment -%}
          {% liquid
            assign display_locked    = false
            assign display_start_raw = product.metafields.product.display_start_at
            assign display_end_raw   = product.metafields.product.display_end_at

            if display_start_raw != blank or display_end_raw != blank
              assign now_ts = 'now' | date: '%s'

              if display_start_raw != blank
                assign start_ts = display_start_raw | date: '%s'
              endif

              if display_end_raw != blank
                assign end_ts = display_end_raw | date: '%s'
              endif

              if display_start_raw != blank and display_end_raw == blank
                # start のみ → その日時より前は NG
                if now_ts < start_ts
                  assign display_locked = true
                endif

              elsif display_start_raw == blank and display_end_raw != blank
                # end のみ → その日時より後は NG
                if now_ts > end_ts
                  assign display_locked = true
                endif

              elsif display_start_raw != blank and display_end_raw != blank
                # start & end → 期間外は NG（期間内のみ表示）
                if now_ts < start_ts or now_ts > end_ts
                  assign display_locked = true
                endif
              endif
            endif
          %}

                    {%- comment -%}
            ▼ バッジ判定
            NEW … 公開日が設定日数以内 / tag:new / metafield custom.new_until が未来
            予約受付中 … PRE-ORDER 判定ロジック（テンプレート／タグ／メタフィールド）
            初回特典残りわずか … 「初回特典」バリアントの合計在庫が閾値以下
            早期予約特典あり … 予約商品かつ「早期予約特典あり」バリアントが存在
            締切間近 … sell_end_at の10日前～当日
          {%- endcomment -%}

          {%- assign now_ts    = 'now' | date: '%s' | plus: 0 -%}
          {%- assign new_days  = section.settings.new_days | default: 14 | plus: 0 -%}
          {%- assign days_sec  = new_days | times: 86400 -%}
          {%- assign cutoff_ts = now_ts | minus: days_sec -%}

          {%- comment %} ========== NEW（公開日 / tag:new / metafield new_until） ========== {%- endcomment -%}
          {%- assign pub_ts = 0 -%}
          {%- if product.published_at != blank -%}
            {%- assign pub_ts = product.published_at | date: '%s' | plus: 0 -%}
          {%- endif -%}
          {%- assign is_new_published = false -%}
          {%- if pub_ts != 0 and pub_ts > cutoff_ts -%}{%- assign is_new_published = true -%}{%- endif -%}

          {%- assign tags_lc   = product.tags | join: ',' | downcase -%}
          {%- assign tags_wrap = ',' | append: tags_lc | append: ',' -%}
          {%- assign is_new_tag = false -%}
          {%- if tags_wrap contains ',new,' -%}{%- assign is_new_tag = true -%}{%- endif -%}

          {%- assign is_new_mf = false -%}
          {%- if product.metafields.custom.new_until != blank -%}
            {%- assign new_until_ts = product.metafields.custom.new_until | date: '%s' | plus: 0 -%}
            {%- if new_until_ts > now_ts -%}{%- assign is_new_mf = true -%}{%- endif -%}
          {%- endif -%}

          {%- assign is_new = false -%}
          {%- if is_new_published or is_new_tag or is_new_mf -%}{%- assign is_new = true -%}{%- endif -%}

          {%- comment %} ========== 予約受付中（PRE-ORDER 判定） ========== {%- endcomment -%}
          {%- assign t_suffix = product.template_suffix | downcase | default: '' -%}

          {%- assign pre_ok = false -%}
          {%- if t_suffix contains 'preorder' or
                tags_wrap contains ',preorder,' or
                tags_wrap contains ',pre-order,' or
                tags_wrap contains ',pre order,' or
                tags_lc  contains '予約' or
                tags_lc  contains '先行' or
                tags_lc  contains '先行予約' or
                product.metafields.custom.preorder -%}
            {%- assign pre_ok = true -%}
          {%- endif -%}

          {%- comment -%} ========== 初回特典残りわずか / 早期予約特典あり / 締切間近 ========== {%- endcomment -%}
          {%- assign first_bonus_total = 0 -%}     {%- comment %}初回特典バリアント在庫の合計{% endcomment %}
          {%- assign first_bonus_low   = false -%}
          {%- assign early_bonus       = false -%}
          {%- assign closing_soon      = false -%}

          {%- assign first_bonus_threshold = 10     | plus: 0 -%}   {%- comment %}「残りわずか」の閾値{% endcomment %}
          {%- assign ten_days_sec          = 864000 | plus: 0 -%}   {%- comment %}10日 = 10 * 86400{% endcomment %}
          {%- assign min_end_ts            = 0 -%}

          {%- for v in product.variants -%}
            {%- assign v_inventory        = v.inventory_quantity | default: 0 | plus: 0 -%}
            {%- assign v_is_first_bonus   = v.metafields.custom.is_first_bonus.value -%}
            {%- assign v_is_early_bonus   = v.metafields.custom.is_early_bonus.value -%}

            {%- comment -%}
              ▼ 初回特典残りわずか
              ・メタフィールド custom.is_first_bonus = true のバリアントだけ対象
              ・その在庫を合計して first_bonus_total に入れる
            {%- endcomment -%}
            {%- if v_is_first_bonus and v_inventory > 0 -%}
              {%- assign first_bonus_total = first_bonus_total | plus: v_inventory -%}
            {%- endif -%}

            {%- comment -%}
              ▼ 早期予約特典あり
              ・商品が予約受付中（pre_ok = true）
              ・かつ、いずれかのバリアントで custom.is_early_bonus = true
            {%- endcomment -%}
            {%- if pre_ok and v_is_early_bonus -%}
              {%- assign early_bonus = true -%}
            {%- endif -%}

            {%- comment -%}
              ▼ 締切間近
              ・各バリアントの variant.sell_end_at を見て、一番近い日時を min_end_ts に保存
            {%- endcomment -%}
            {%- assign v_end_raw = v.metafields.variant.sell_end_at -%}
            {%- if v_end_raw != blank -%}
              {%- assign v_end_ts = v_end_raw | date: '%s' | plus: 0 -%}
              {%- if min_end_ts == 0 or v_end_ts < min_end_ts -%}
                {%- assign min_end_ts = v_end_ts -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}

          {%- comment -%}
            初回特典バリアントの在庫合計が 1〜閾値以内のときだけ true
          {%- endcomment -%}
          {%- if first_bonus_total > 0 and first_bonus_total <= first_bonus_threshold -%}
            {%- assign first_bonus_low = true -%}
          {%- endif -%}

          {%- if min_end_ts != 0 -%}
            {%- assign closing_from_ts = min_end_ts | minus: ten_days_sec -%}
            {%- if now_ts >= closing_from_ts and now_ts <= min_end_ts -%}
              {%- assign closing_soon = true -%}
            {%- endif -%}
          {%- endif -%}

          <a class="csh-card{% if display_locked %} csh-card--locked{% endif %}"
            {% unless display_locked %}
              href="{{ product.url | within: the_collection }}"
            {% endunless %} >

            <div class="csh-thumb">
              {% if product.featured_image %}
                {{ product.featured_image | image_url: width: 700 | image_tag: loading: 'lazy', alt: product.title }}
              {% endif %}
            </div>

            {% if section.settings.show_badges %}
              <div class="csh-badges csh-badges--below">
                {%- if is_new and pre_ok == false -%}
                  <span class="csh-badge csh-badge--new">NEW</span>
                {%- endif -%}

                {%- if pre_ok -%}
                  <span class="csh-badge csh-badge--pre">予約受付中</span>
                {%- endif -%}

                {%- if first_bonus_low -%}
                  <span class="csh-badge csh-badge--first-bonus">初回特典残りわずか</span>
                {%- endif -%}

                {%- if early_bonus -%}
                  <span class="csh-badge csh-badge--early">早期予約特典あり</span>
                {%- endif -%}

                {%- if closing_soon -%}
                  <span class="csh-badge csh-badge--closing">締切間近</span>
                {%- endif -%}
              </div>
            {% endif %}

            <div class="csh-body">
              <div class="csh-name">{{ product.title }}</div>
              {% if section.settings.show_price %}
                <div class="csh-price">
                  {% if product.price_varies %}
                    {{ product.price_min | money }} — {{ product.price_max | money }}
                  {% else %}
                    {{ product.price | money }}
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="csh-empty">このコレクションに商品がありません。</p>
    {% endif %}
  {% else %}
    <p class="csh-empty">セクション設定でコレクションを選択してください。</p>
  {% endif %}

  <style>
  /* ===== 見出し行 ===== */
  #csh-{{ section.id }} .csh-head{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
  #csh-{{ section.id }} .csh-title{ position:relative; margin:0; font-size:18px; font-weight:700; padding-left:14px; }
  #csh-{{ section.id }} .csh-title::before{ content:""; position:absolute; left:0; top:0; width:3px; height:1.1em; background: var(--csh-accent, #e63946); border-radius:2px; }

  /* “もっと見る” */
  #csh-{{ section.id }} .csh-more{ display:inline-flex; align-items:center; gap:10px; text-decoration:none; color: inherit; font-size:14px; font-weight:600; }
  #csh-{{ section.id }} .csh-more-icon{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; min-width:32px; border-radius:999px; background: var(--csh-accent, #e63946); }
  #csh-{{ section.id }} .csh-more-icon svg{ width:18px; height:18px; stroke:#fff; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

  /* ===== グリッド ===== */
  #csh-{{ section.id }} .csh-grid{ display:grid; grid-template-columns: repeat({{ section.settings.columns_desktop | default: 6 }}, minmax(0,1fr)); gap: var(--csh-gap-pc); }

  /* ===== カード ===== */
  #csh-{{ section.id }} .csh-card{ display:flex; flex-direction:column; color:inherit; text-decoration:none; }

  /* ===== サムネイル ===== */
  #csh-{{ section.id }} .csh-thumb{ border-radius:5px; overflow:hidden; background:#0b0f14; }
  #csh-{{ section.id }} .csh-thumb img{ width:100%; height:auto; display:block; border-radius:5px; }
  #csh-{{ section.id }} .csh-thumb::before{ content:none !important; }

  /* バッジ（画像の下） */
  #csh-{{ section.id }} .csh-badges--below{ display:flex; gap:6px; margin-top:8px; }
  #csh-{{ section.id }} .csh-badge{ font-size:10px; font-weight:700; line-height:1; padding:6px 8px; color:#fff; box-shadow:0 1px 2px rgba(0,0,0,.15); }
  #csh-{{ section.id }} .csh-badge--new{ background:#e63946; }
  #csh-{{ section.id }} .csh-badge--pre{ background:#3B82F6; color:#fff; border-radius:0; }

  /* 追加バッジ色 */
  #csh-{{ section.id }} .csh-badge--first-bonus{ background:#ef4444; }  /* 初回特典残りわずか：赤 */
  #csh-{{ section.id }} .csh-badge--early{        background:#22c55e; }  /* 早期予約特典あり：緑 */
  #csh-{{ section.id }} .csh-badge--closing{      background:#f97316; }  /* 締切間近：オレンジ */

  #csh-{{ section.id }} .csh-body{ padding:10px 12px 10px 0; display:grid; gap:6px; }
  #csh-{{ section.id }} .csh-name{ font-size:13px; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  #csh-{{ section.id }} .csh-price{ font-size:12px; opacity:.9; }

  /* ===== csh: バッジの折り返し制御（強制版） ===== */
  #csh-{{ section.id }} .csh-badges.csh-badges--below{
    display:flex !important;
    flex-wrap:wrap !important;
    gap:6px 6px;
  }

  #csh-{{ section.id }} .csh-badges.csh-badges--below .csh-badge{
    display:inline-flex !important;
    align-items:center;
    white-space:nowrap !important;   /* 文字は折り返さない */
    min-width:max-content;           /* バッジ幅を文字幅に合わせる */
  }

  /* ===== SP ===== */
  @media (max-width: 768px){
    #csh-{{ section.id }}{ position:relative; }
    #csh-{{ section.id }} .csh-grid{
      display:flex !important; gap: var(--csh-gap-sp);
      overflow-x:auto; overflow-y:visible; -webkit-overflow-scrolling:touch;
      scroll-snap-type:x proximity; scroll-snap-stop:normal; scrollbar-gutter:stable;
      width: calc(100vw - var(--csh-safe));
      margin-right: calc(50% - 50vw - var(--csh-gap-sp));
      padding-bottom: 72px;
    }
    #csh-{{ section.id }} .csh-card{ flex:0 0 clamp(140px, 38vw, 240px); width: clamp(140px, 38vw, 240px); scroll-snap-align:start; }
    #csh-{{ section.id }} .csh-grid::after{ content:""; flex: 0 0 calc(max(0px, var(--csh-safe) - var(--csh-gap-sp))); }
    #csh-{{ section.id }} .csh-more{ position:absolute; right: var(--csh-safe); bottom: 60px; }
  }

  /* ===== display_start_at / display_end_at でロックされたカード ===== */
  #csh-{{ section.id }} .csh-card.csh-card--locked{
    opacity: 0.4;
    pointer-events: none;
    cursor: default;
  }
  </style>
</section>

{% schema %}
{
  "name": "汎用コレクション（Custom）",
  "settings": [
    { "type": "collection", "id": "collection", "label": "コレクションを選択" },
    { "type": "range", "id": "limit", "label": "最大表示数", "min": 1, "max": 50, "step": 1, "default": 12 },
    { "type": "checkbox", "id": "show_price", "label": "価格を表示", "default": true },
    { "type": "checkbox", "id": "show_badges", "label": "商品ラベル（NEW / 予約受付中 / 初回特典残りわずか / 早期予約特典あり / 締切間近）を表示", "default": true },
    { "type": "range", "id": "new_days", "label": "NEW判定（日数以内の公開）", "min": 1, "max": 60, "step": 1, "default": 14 },

    { "type": "header", "content": "レイアウト" },
    { "type": "range", "id": "columns_desktop", "label": "（PC）列数", "min": 2, "max": 8, "step": 1, "default": 6 },
    { "type": "range", "id": "gap_pc", "label": "（PC）カード間隔(px)", "min": 8, "max": 32, "step": 2, "default": 16 },
    { "type": "range", "id": "gap_sp", "label": "（SP）カード間隔(px)", "min": 6, "max": 24, "step": 1, "default": 12 },

    { "type": "header", "content": "余白 / 背景" },
    { "type": "range", "id": "padding-block-start", "label": "上余白", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 36 },
    { "type": "range", "id": "padding-block-end", "label": "下余白", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 36 },
    { "type": "color", "id": "bg_color", "label": "背景色", "default": "#F5F6F9" },

    { "type": "color_scheme", "id": "color_scheme", "label": "配色（Horizonのスキーム）", "default": "scheme-1" },
    { "type": "color", "id": "accent_color", "label": "アクセントカラー（左線／丸アイコン）", "default": "#E63946" }
  ],
  "presets": [{ "name": "汎用コレクション（Custom）" }]
}
{% endschema %}
