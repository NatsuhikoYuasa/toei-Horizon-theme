{% assign the_collection = section.settings.collection %}

<section
  id="csh-{{ section.id }}"
  class="csh section page-width color-{{ section.settings.color_scheme }}"
  style="
    {% render 'spacing-style', settings: section.settings %}
    --csh-gap-pc: {{ section.settings.gap_pc | default: 16 }}px;
    --csh-gap-sp: {{ section.settings.gap_sp | default: 12 }}px;
    --csh-safe: var(--full-page-grid-margin-inline-offset, var(--page-margin-inline-offset, 16px));
    --csh-accent: {{ section.settings.accent_color | default: '#E63946' }};
    padding-block-start: {{ section.settings['padding-block-start'] | default: 36 }}px;
    padding-block-end:   {{ section.settings['padding-block-end']   | default: 36 }}px;
    {% if section.settings.bg_color != blank %}background: {{ section.settings.bg_color }};{% endif %}
  "
>
  {% if the_collection %}
    <div class="csh-head">
      <h2 class="csh-title">{{ the_collection.title }}</h2>
      <a class="csh-more" href="{{ the_collection.url }}" aria-label="{{ the_collection.title }}をもっと見る">
        <span class="csh-more-text">{{ the_collection.title }}をもっと見る</span>
        <span class="csh-more-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
            <path d="M8 5l7 7-7 7" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </a>
    </div>

    {% if the_collection.products_count > 0 %}
      <div class="csh-grid">
        {% for product in the_collection.products limit: section.settings.limit %}
          {%- comment -%} display_start_at / display_end_at による表示ロック判定 {%- endcomment -%}
          {% liquid
            assign display_locked = false
            assign display_start_raw = product.metafields.product.display_start_at
            assign display_end_raw = product.metafields.product.display_end_at

            if display_start_raw != blank or display_end_raw != blank
              assign now_ts = 'now' | date: '%s'

              if display_start_raw != blank
                assign start_ts = display_start_raw | date: '%s'
              endif

              if display_end_raw != blank
                assign end_ts = display_end_raw | date: '%s'
              endif

              if display_start_raw != blank and display_end_raw == blank
                # start のみ → その日時より前は NG
                if now_ts < start_ts
                  assign display_locked = true
                endif

              elsif display_start_raw == blank and display_end_raw != blank
                # end のみ → その日時より後は NG
                if now_ts > end_ts
                  assign display_locked = true
                endif

              elsif display_start_raw != blank and display_end_raw != blank
                # start & end → 期間外は NG（期間内のみ表示）
                if now_ts < start_ts or now_ts > end_ts
                  assign display_locked = true
                endif
              endif
            endif
          %}

          <a
            class="csh-card{% if display_locked %} csh-card--locked{% endif %}"
            {% unless display_locked %}
              href="{{ product.url | within: the_collection }}"
            {% endunless %}
          >
            <div class="csh-thumb">
              {% if product.featured_image %}
                {{ product.featured_image | image_url: width: 700 | image_tag: loading: 'lazy', alt: product.title }}
              {% endif %}
            </div>

            {% if section.settings.show_badges %}
              <div class="csh-badges csh-badges--below">
                {% render 'Custom-product-badges', badge_product: product, badge_class: 'csh-badge' %}
              </div>
            {% endif %}

            <div class="csh-body">
              <div class="csh-name">{{ product.title }}</div>
              {% if section.settings.show_price %}
                <div class="csh-price">
                  {% if product.price_varies %}
                    {{ product.price_min | money }} — {{ product.price_max | money }}
                  {% else %}
                    {{ product.price | money }}
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="csh-empty">このコレクションに商品がありません。</p>
    {% endif %}
  {% else %}
    <p class="csh-empty">セクション設定でコレクションを選択してください。</p>
  {% endif %}

  <style>
    /* ===== 見出し行 ===== */
    #csh-{{ section.id }} .csh-head{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
    #csh-{{ section.id }} .csh-title{ position:relative; margin:0; font-size:18px; font-weight:700; padding-left:14px; }
    #csh-{{ section.id }} .csh-title::before{ content:""; position:absolute; left:0; top:0; width:3px; height:1.1em; background: var(--csh-accent, #e63946); border-radius:2px; }

    /* “もっと見る” */
    #csh-{{ section.id }} .csh-more{ display:inline-flex; align-items:center; gap:10px; text-decoration:none; color: inherit; font-size:14px; font-weight:600; }
    #csh-{{ section.id }} .csh-more-icon{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; min-width:32px; border-radius:999px; background: var(--csh-accent, #e63946); }
    #csh-{{ section.id }} .csh-more-icon svg{ width:18px; height:18px; stroke:#fff; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

    /* ===== グリッド ===== */
    #csh-{{ section.id }} .csh-grid{ display:grid; grid-template-columns: repeat({{ section.settings.columns_desktop | default: 6 }}, minmax(0,1fr)); gap: var(--csh-gap-pc); }

    /* ===== カード ===== */
    #csh-{{ section.id }} .csh-card{ display:flex; flex-direction:column; color:inherit; text-decoration:none; }

    /* ===== サムネイル ===== */
    #csh-{{ section.id }} .csh-thumb{ border-radius:5px; overflow:hidden; background:#0b0f14; }
    #csh-{{ section.id }} .csh-thumb img{ width:100%; height:auto; display:block; border-radius:5px; }
    #csh-{{ section.id }} .csh-thumb::before{ content:none !important; }

    /* バッジ（画像の下） */
    #csh-{{ section.id }} .csh-badges--below{
      display:flex !important;
      flex-wrap:wrap !important;
      gap:6px 6px;
      margin-top:8px;
    }

    /* セクション固有の形・サイズなど */
    #csh-{{ section.id }} .csh-badge{
      font-size:10px;
      font-weight:700;
      line-height:1;
      padding:6px 8px;
      box-shadow:0 1px 2px rgba(0,0,0,.15);
      border-radius:0;
      display:inline-flex;
      align-items:center;
      white-space:nowrap;
      min-width:max-content;
    }

    #csh-{{ section.id }} .csh-body{ padding:10px 12px 10px 0; display:grid; gap:6px; }
    #csh-{{ section.id }} .csh-name{ font-size:13px; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    #csh-{{ section.id }} .csh-price{ font-size:12px; opacity:.9; }

    /* ===== SP ===== */
    @media (max-width: 768px){
      #csh-{{ section.id }}{ position:relative; }
      #csh-{{ section.id }} .csh-grid{
        display:flex !important; gap: var(--csh-gap-sp);
        overflow-x:auto; overflow-y:visible; -webkit-overflow-scrolling:touch;
        scroll-snap-type:x proximity; scroll-snap-stop:normal; scrollbar-gutter:stable;
        width: calc(100vw - var(--csh-safe));
        margin-right: calc(50% - 50vw - var(--csh-gap-sp));
        padding-bottom: 72px;
      }
      #csh-{{ section.id }} .csh-card{ flex:0 0 clamp(140px, 38vw, 240px); width: clamp(140px, 38vw, 240px); scroll-snap-align:start; }
      #csh-{{ section.id }} .csh-grid::after{ content:""; flex: 0 0 calc(max(0px, var(--csh-safe) - var(--csh-gap-sp))); }
      #csh-{{ section.id }} .csh-more{ position:absolute; right: var(--csh-safe); bottom: 60px; }
    }

    /* ===== display_start_at / display_end_at でロックされたカード ===== */
    #csh-{{ section.id }} .csh-card.csh-card--locked{
      opacity: 0.4;
      pointer-events: none;
      cursor: default;
    }
  </style>
</section>

{% schema %}
{
  "name": "汎用コレクション（Custom）",
  "settings": [
    { "type": "collection", "id": "collection", "label": "コレクションを選択" },
    { "type": "range", "id": "limit", "label": "最大表示数", "min": 1, "max": 50, "step": 1, "default": 12 },
    { "type": "checkbox", "id": "show_price", "label": "価格を表示", "default": true },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "商品ラベル（NEW / 予約受付中 / 初回特典残りわずか / 早期予約特典あり / 締切間近）を表示",
      "default": true
    },
    { "type": "header", "content": "レイアウト" },
    { "type": "range", "id": "columns_desktop", "label": "（PC）列数", "min": 2, "max": 8, "step": 1, "default": 6 },
    { "type": "range", "id": "gap_pc", "label": "（PC）カード間隔(px)", "min": 8, "max": 32, "step": 2, "default": 16 },
    { "type": "range", "id": "gap_sp", "label": "（SP）カード間隔(px)", "min": 6, "max": 24, "step": 1, "default": 12 },

    { "type": "header", "content": "余白 / 背景" },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "上余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "下余白",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 36
    },
    { "type": "color", "id": "bg_color", "label": "背景色", "default": "#F5F6F9" },

    { "type": "color_scheme", "id": "color_scheme", "label": "配色（Horizonのスキーム）", "default": "scheme-1" },
    { "type": "color", "id": "accent_color", "label": "アクセントカラー（左線／丸アイコン）", "default": "#E63946" }
  ],
  "presets": [{ "name": "汎用コレクション（Custom）" }]
}
{% endschema %}
