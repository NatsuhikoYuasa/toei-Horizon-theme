{% comment %}
  メールニュース登録ページ用セクション
  - ログイン会員前提
  - Shopify の customer フォームで contact[email] を送信し、
    newsletter タグを付けて accepts_marketing を ON にする
{% endcomment %}

<section class="section section-newsletter-settings toei-section toei-section--newsletter">
  <div class="toei-container">

    {%- render 'page-breadcrumbs',
      top_label: 'トップ',
      top_url: routes.root_url,
      level_1_title: 'マイページ',
      level_1_url: '/pages/mypage',
      current_title: 'メールニュース登録'
    -%}

    <h1 class="heading-page">メールニュース登録</h1>

    {% if customer %}

      {% form 'customer', id: 'NewsletterForm', class: 'newsletter-settings__form' %}

        {% if form.posted_successfully? %}
          <p class="form-status form-status--success">
            ご登録ありがとうございます。キャンペーン情報をメールでお届けします。
          </p>
        {% elsif form.errors %}
          <div class="form-status form-status--error">
            {{ form.errors | default_errors }}
          </div>
        {% endif %}

        <div class="mypage-setting-card newsletter-settings__card">
          <div class="newsletter-settings__row newsletter-settings__row--email">
            <div class="newsletter-settings__label">ご登録メールアドレス</div>
            <div class="newsletter-settings__value">
              <p class="newsletter-settings__email">{{ customer.email }}</p>
              <a href="{{ routes.account_url }}" class="newsletter-settings__email-edit">
                メールアドレスの変更はこちら
              </a>
            </div>
          </div>

          <div class="newsletter-settings__row newsletter-settings__row--preference">
            <div class="newsletter-settings__label">配信設定</div>
            <div class="newsletter-settings__value">
              <label class="newsletter-settings__option">
                <input
                  type="radio"
                  name="newsletter_preference"
                  value="on"
                  checked
                >
                <span>配信を希望する</span>
              </label>

              {%- comment -%}
                「配信を希望しない」は今は UI のみ。
                実際の配信停止は、メール本文の解除リンクや別の仕組みで対応予定。
              {%- endcomment -%}
              <label class="newsletter-settings__option newsletter-settings__option--disabled">
                <input
                  type="radio"
                  name="newsletter_preference"
                  value="off"
                  disabled
                >
                <span>配信を希望しない（メール内の解除リンクから変更できます）</span>
              </label>
            </div>
          </div>
        </div>

        {%- comment -%}
          newsletter 用フォーム仕様:
          - type: email
          - name: contact[email]
          - contact[tags]=newsletter を付与
          これにより newsletter タグ付きで accepts_marketing が ON の customer が作成/更新される。
        {%- endcomment -%}
        <input
          type="email"
          name="contact[email]"
          value="{{ customer.email }}"
          class="newsletter-settings__email-input"
          hidden
          aria-hidden="true"
        >
        <input
          type="hidden"
          name="contact[tags]"
          value="newsletter"
        >

        <div class="newsletter-settings__actions">
          <a href="/pages/mypage" class="button button--secondary">
            マイページに戻る
          </a>
          <button type="submit" class="button button--primary">
            変更する
          </button>
        </div>

      {% endform %}

    {% else %}
      <div class="mypage-setting-card newsletter-settings__card">
        <p>メールニュース登録を行うにはログインが必要です。</p>
        <div class="newsletter-settings__actions">
          <a href="{{ routes.account_login_url }}" class="button button--primary">
            ログインする
          </a>
        </div>
      </div>
    {% endif %}

  </div>
</section>

{% schema %}
{
  "name": "メールニュース登録",
  "tag": "section",
  "class": "section section-newsletter-settings",
  "settings": [],
  "blocks": [],
  "presets": [
    {
      "name": "メールニュース登録"
    }
  ]
}
{% endschema %}
