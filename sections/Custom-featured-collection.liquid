{% assign the_collection = section.settings.collection %}

<section id="section-{{ section.id }}" class="section page-width cfc-collection-feature">
  <div class="cfc-container">
    <!-- Left: collection image + CTA -->
    <div class="cfc-left">
      {% if the_collection and the_collection.image %}
        {{
          the_collection.image
          | image_url: width: 960
          | image_tag: loading: 'lazy', alt: the_collection.title, class: 'cfc-left-img'
        }}
      {% else %}
        <div class="cfc-placeholder">コレクション画像を設定してください</div>
      {% endif %}

      {% if the_collection %}
        <a class="cfc-cta" href="{{ the_collection.url }}" aria-label="{{ the_collection.title }}を見る">
          <span class="cfc-cta-text">今すぐチェック</span>
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M13.172 12 8.222 7.05l1.414-1.414L16 12l-6.364 6.364-1.414-1.414z" fill="currentColor"/>
          </svg>
        </a>
      {% endif %}
    </div>

    <!-- Right: title + products -->
    <div class="cfc-right">
      {% if the_collection %}
        <h2 class="cfc-title">{{ the_collection.title }}</h2>

        {% if the_collection.products_count > 0 %}
          <div class="cfc-grid">
            {% assign shown_count = 0 %}
            {% for product in the_collection.products %}
              {%- comment -%} display_start_at / display_end_at による表示ロック判定 {%- endcomment -%}
              {% liquid
                assign display_locked = false
                assign display_start_raw = product.metafields.product.display_start_at
                assign display_end_raw = product.metafields.product.display_end_at

                if display_start_raw != blank or display_end_raw != blank
                  assign now_ts = 'now' | date: '%s'

                  if display_start_raw != blank
                    assign start_ts = display_start_raw | date: '%s'
                  endif

                  if display_end_raw != blank
                    assign end_ts = display_end_raw | date: '%s'
                  endif

                  if display_start_raw != blank and display_end_raw == blank
                    if now_ts < start_ts
                      assign display_locked = true
                    endif
                  elsif display_start_raw == blank and display_end_raw != blank
                    if now_ts > end_ts
                      assign display_locked = true
                    endif
                  elsif display_start_raw != blank and display_end_raw != blank
                    if now_ts < start_ts or now_ts > end_ts
                      assign display_locked = true
                    endif
                  endif
                endif
              %}

              {% comment %} ロック商品はカード自体を表示しない {% endcomment %}
              {% if display_locked %}
                {% continue %}
              {% endif %}

              <a
                class="cfc-card"
                href="{{ product.url | within: the_collection }}"
              >
                <div class="cfc-card-media">
                  {% if product.featured_image %}
                    {{
                      product.featured_image
                      | image_url: width: 600
                      | image_tag: loading: 'lazy', alt: product.title
                    }}
                  {% else %}
                    <div class="cfc-noimg">No Image</div>
                  {% endif %}
                </div>

                {% if section.settings.show_badges %}
                  <div class="cfc-badges cfc-badges--below">
                    {% render 'Custom-product-badges', badge_product: product, badge_class: 'cfc-badge' %}
                  </div>
                {% endif %}

                <div class="cfc-card-body">
                  <div class="cfc-card-title">{{ product.title }}</div>
                  <div class="cfc-card-price">
                    {%- assign has_sale = false -%}
                    {%- if product.compare_at_price_max > product.price -%}
                      {%- assign has_sale = true -%}
                    {%- endif -%}

                    {%- if has_sale -%}
                      <span class="cfc-card-price-current">{{ product.price | money }}</span>
                      <span class="cfc-card-price-compare"
                        ><s>{{ product.compare_at_price_max | money }}</s></span
                      >
                    {%- else -%}
                      <span class="cfc-card-price-current">
                        {%- if product.price_varies -%}
                          {{ product.price_min | money }} — {{ product.price_max | money }}
                        {%- else -%}
                          {{ product.price | money }}
                        {%- endif -%}
                      </span>
                    {%- endif -%}
                    <span class="cfc-card-price-tax">（税込）</span>
                  </div>
                </div>
              </a>
              {% assign shown_count = shown_count | plus: 1 %}
              {% if shown_count >= 4 %}
                {% break %}
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <p class="cfc-empty">このコレクションに商品がありません。</p>
        {% endif %}
      {% else %}
        <p class="cfc-empty">セクション設定でコレクションを選択してください。</p>
      {% endif %}
    </div>
  </div>

    <style>
    /* ===== Theme tokens（既存のまま） ===== */
    #section-{{ section.id }}.cfc-collection-feature {
      --bg:#060816; --fg:#e6edf3; --muted:#9aa4b2;
      --card:#161b22; --cardBorder:#222833;
      --cta:#e63946; --ctaFg:#fff;
    }

    /* Section：上下の余白のみ（既存を維持） */
    #section-{{ section.id }}.cfc-collection-feature {
      background:var(--bg); color:var(--fg);
      padding-block: clamp(64px,10vw,120px);
      padding-inline: 0;
      overflow-x:hidden;
    }

    /* 中央カラム（デフォルト：1 カラム） */
    #section-{{ section.id }} .cfc-container {
      display:grid;
      grid-template-columns:1fr;
      gap:clamp(44px,6vw,96px);
      align-items:start;
    }

    /* LEFT */
    #section-{{ section.id }} .cfc-left { position:relative; }
    #section-{{ section.id }} .cfc-left-img {
      display:block;
      width:100%;
      height:auto;
      border-radius:5px;
    }
    #section-{{ section.id }} .cfc-placeholder {
      background:var(--card);
      border:1px solid var(--cardBorder);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
    }

    /* CTA */
    #section-{{ section.id }} .cfc-cta {
      margin-top:16px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      background:var(--cta);
      color:var(--ctaFg);
      padding:12px 18px;
      border-radius:5px;
      font-weight:600;
      text-decoration:none;
    }
    #section-{{ section.id }} .cfc-cta:hover { opacity:.9; }
    #section-{{ section.id }} .cfc-cta-text { flex:0 1 auto; }

    /* RIGHT */
    #section-{{ section.id }} .cfc-title {
      font-size:22px;
      line-height:1.35;
      margin:0 0 16px 0;
      font-weight:700;
      border-bottom:1px solid var(--cardBorder);
      padding-bottom:10px;
    }

    /* Products（デフォルト：フレックス。PC では後で上書き） */
    #section-{{ section.id }} .cfc-grid {
      display:flex;
      gap: {{ section.settings.card_gap | default: 16 }}px;
      padding:0;
    }
    #section-{{ section.id }} .cfc-grid > * { flex:0 0 auto; }

    #section-{{ section.id }} .cfc-card {
      overflow:visible;
      text-decoration:none;
      color:var(--fg);
      display:flex;
      flex-direction:column;
    }

    #section-{{ section.id }} .cfc-card-media {
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 5px;
      overflow: hidden;
    }
    #section-{{ section.id }} .cfc-card-media img {
      width:100%;
      height:100%;
      border-radius:5px;
    }

    /* ▼ バッジ（画像の下） */
    #section-{{ section.id }} .cfc-badges.cfc-badges--below{
      display:flex;
      flex-wrap:wrap;
      gap:6px 6px;
      margin-top:8px;
    }

    /* 形・サイズのみ。色は .badge--xxx に委譲 */
    #section-{{ section.id }} .cfc-badge{
      font-size:10px;
      font-weight:700;
      line-height:1;
      padding:6px 8px;
      border-radius:0;
      box-shadow:0 1px 2px rgba(0,0,0,.15);
      display:inline-flex;
      align-items:center;
      white-space:nowrap;
      min-width:max-content;
    }

    #section-{{ section.id }} .cfc-card-body {
      padding:8px 12px 10px 0;
      display:grid;
      gap:6px;
    }
    #section-{{ section.id }} .cfc-card-title {
      font-size:13px;
      line-height:1.4;
    }
    #section-{{ section.id }} .cfc-card-price {
      font-size:12px;
      color:var(--muted);
    }
    #section-{{ section.id }} .cfc-empty { color:var(--muted); }

    /* display_start_at / display_end_at でロックされたカード */
    #section-{{ section.id }} .cfc-card.cfc-card--locked{
      opacity: 0.4;
      pointer-events: none;
      cursor: default;
    }

    .cfc-card-price-tax {
      font-size: 10px;
    }

    /* ===== Desktop（>=769px） 左 2 カラム + 右 4 カラム ===== */
    @media (min-width: 769px) {
      /* 全体を 6 カラムに分割 */
      #section-{{ section.id }} .cfc-container {
        display:grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: {{ section.settings.card_gap | default: 16 }}px;
        align-items:flex-start;
      }

      /* 左の大きいカードは 2 カラム分 */
      #section-{{ section.id }} .cfc-left {
        grid-column: 1 / span 2;
      }

      /* 右側ブロックは残り 4 カラム */
      #section-{{ section.id }} .cfc-right {
        grid-column: 3 / span 4;
      }

      /* 右側 4 枚をきれいに 4 カラムに */
      #section-{{ section.id }} .cfc-grid {
        display:grid !important;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: {{ section.settings.card_gap | default: 16 }}px !important;
        overflow:visible;
      }

      #section-{{ section.id }} .cfc-card {
        min-width:0;
      }

      #section-{{ section.id }} .cfc-left-img {
        width: 90%;
      }
    }

    /* ===== Smartphone（<=768px） ===== */
    @media (max-width: 768px){
      #section-{{ section.id }} .cfc-container{
        display: block !important;
      }
      #section-{{ section.id }}.cfc-collection-feature{
        overflow: visible;
      }

      #section-{{ section.id }} .cfc-left .cfc-cta{
        display: flex;
      }
      #section-{{ section.id }} .cfc-cta-text {
        flex:1 1 auto;
        text-align:left;
      }
      #section-{{ section.id }} .cfc-cta svg {
        flex:0 0 auto;
        margin-left:auto;
      }

      #section-{{ section.id }} .cfc-right {
        overflow: visible;
      }
      #section-{{ section.id }} .cfc-right > .cfc-grid {
        display: flex;
        gap: var(--cfc-gap-sp);
        overflow-x: auto;
        overflow-y: visible;
        -webkit-overflow-scrolling: touch;
        touch-action: auto;
        scroll-snap-type: x proximity;
        scroll-snap-stop: normal;
        scrollbar-gutter: stable;
        width: calc(100vw - var(--cfc-safe-inline));
        margin-left: 0;
        padding-left: 0;
        margin-right: calc(50% - 50vw - var(--cfc-gap-sp));
        padding-right: 0;
        scroll-padding-right: var(--cfc-safe-inline);
        overscroll-behavior-x: contain;
      }
      #section-{{ section.id }} .cfc-right > .cfc-grid::after{
        content:"";
        flex: 0 0 calc(max(0px, var(--cfc-safe-inline) - var(--cfc-gap-sp)));
      }

      #section-{{ section.id }} {
        --cfc-safe-inline: var(--full-page-grid-margin-inline-offset, var(--page-margin-inline-offset, 16px));
        --cfc-gap-sp: {{ section.settings.card_gap_mobile | default: 12 }}px;
      }

      #section-{{ section.id }} .cfc-right > .cfc-grid .cfc-card {
        flex: 0 0 clamp(140px, 38vw, 240px);
        width: clamp(140px, 38vw, 240px);
        scroll-snap-align: start;
      }

      #section-{{ section.id }} .cfc-title {
        margin-top: 40px;
      }
    }
  </style>

</section>

{% schema %}
{
  "name": "特集コレクション（Custom）",
  "settings": [
    { "type": "collection", "id": "collection", "label": "コレクションを選択" },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "商品ラベル（NEW / 予約受付中 / 初回特典残りわずか / 早期予約特典あり / 締切間近）を表示",
      "default": true
    },
    {
      "type": "range",
      "id": "card_gap",
      "label": "（PC）商品カードの間隔 (px)",
      "min": 8,
      "max": 32,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "card_gap_mobile",
      "label": "（スマホ）商品カードの間隔 (px)",
      "min": 6,
      "max": 24,
      "step": 1,
      "default": 12
    }
  ],
  "presets": [{ "name": "特集コレクション（Custom）", "category": "コレクション" }]
}
{% endschema %}
