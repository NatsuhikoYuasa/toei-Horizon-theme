{% comment %}
  Custom-featured-blog-posts.liquid
  - 「汎用コレクション（Custom）」と同じ csh レイアウトでブログ記事を表示
  - 見出し・「〜をもっと見る」はブログタイトルから自動生成
  - 記事メタフィールド custom.external_url (URL型) があれば外部ページへ遷移
    なければ通常の article.url へ
{% endcomment %}

{% assign the_blog_handle = section.settings.blog %}

<section
  id="csh-{{ section.id }}"
  class="csh section page-width color-{{ section.settings.color_scheme }}"
  style="
    {% render 'spacing-style', settings: section.settings %}
    --csh-gap-pc: {{ section.settings.gap_pc | default: 16 }}px;
    --csh-gap-sp: {{ section.settings.gap_sp | default: 12 }}px;
    --csh-safe: var(--full-page-grid-margin-inline-offset, var(--page-margin-inline-offset, 16px));
    --csh-accent: {{ section.settings.accent_color | default: '#E63946' }};
    padding-block-start: {{ section.settings['padding-block-start'] | default: 36 }}px;
    padding-block-end:   {{ section.settings['padding-block-end']   | default: 36 }}px;
    {% if section.settings.bg_color != blank %}background: {{ section.settings.bg_color }};{% endif %}
  "
>
  {% if the_blog_handle != blank %}
    {% assign the_blog = blogs[the_blog_handle] %}

    {% if the_blog %}
      {%- comment -%} 見出し・もっと見る文言（自動） {%- endcomment -%}
      {%- assign heading_text = the_blog.title | default: 'キャンペーン・イベント情報' -%}
      {%- assign more_label   = heading_text | append: 'をもっと見る' -%}

      <div class="csh-head">
        <h2 class="csh-title">{{ heading_text }}</h2>

        <a
          class="csh-more"
          href="{{ the_blog.url }}"
          aria-label="{{ more_label }}"
        >
          <span class="csh-more-text">{{ more_label }}</span>
          <span class="csh-more-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
              <path d="M8 5l7 7-7 7" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </a>
      </div>

      {% if the_blog.articles_count > 0 %}
        <div class="csh-grid">
          {% for article in the_blog.articles limit: section.settings.limit %}
            {%- liquid
              # 外部URLメタフィールド（custom.external_url）を取得
              assign ext_obj     = article.metafields.custom.external_url
              assign link_url    = article.url
              assign is_external = false

              if ext_obj and ext_obj.value != blank and ext_obj.value != '-' and ext_obj.value != '#'
                assign link_url    = ext_obj.value
                assign is_external = true
              endif
            -%}

            <a
              class="csh-card"
              href="{{ link_url }}"
              {% if is_external %}target="_blank" rel="noopener noreferrer"{% endif %}
            >
              <div class="csh-thumb">
                {% if article.image %}
                  {{ article.image | image_url: width: 700 | image_tag: loading: 'lazy', alt: article.title }}
                {% endif %}
              </div>

              <div class="csh-body">
                <div class="csh-name">{{ article.title }}</div>

                {% if section.settings.show_excerpt %}
                  <div class="csh-price">
                    {{ article.excerpt_or_content | strip_html | truncate: 80 }}
                  </div>
                {% endif %}
              </div>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="csh-empty">このブログに記事がありません。</p>
      {% endif %}
    {% else %}
      <p class="csh-empty">ブログが見つかりません。</p>
    {% endif %}
  {% else %}
    <p class="csh-empty">セクション設定でブログを選択してください。</p>
  {% endif %}

  <style>
  /* ===== 見出し行 ===== */
  #csh-{{ section.id }} .csh-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    margin-bottom:16px;
  }
  #csh-{{ section.id }} .csh-title{
    position:relative;
    margin:0;
    font-size:18px;
    font-weight:700;
    padding-left:14px;
  }
  #csh-{{ section.id }} .csh-title::before{
    content:"";
    position:absolute;
    left:0;
    top:0;
    width:3px;
    height:1.1em;
    background: var(--csh-accent, #e63946);
    border-radius:2px;
  }

  /* “もっと見る” */
  #csh-{{ section.id }} .csh-more{
    display:inline-flex;
    align-items:center;
    gap:10px;
    text-decoration:none;
    color: inherit;
    font-size:14px;
    font-weight:600;
  }
  #csh-{{ section.id }} .csh-more-icon{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:32px;
    height:32px;
    min-width:32px;
    border-radius:999px;
    background: var(--csh-accent, #e63946);
  }
  #csh-{{ section.id }} .csh-more-icon svg{
    width:18px;
    height:18px;
    stroke:#fff;
    fill:none;
    stroke-width:2;
    stroke-linecap:round;
    stroke-linejoin:round;
  }

  /* ===== グリッド ===== */
  #csh-{{ section.id }} .csh-grid{
    display:grid;
    grid-template-columns: repeat({{ section.settings.columns_desktop | default: 4 }}, minmax(0,1fr));
    gap: var(--csh-gap-pc);
  }

  /* ===== カード ===== */
  #csh-{{ section.id }} .csh-card{
    display:flex;
    flex-direction:column;
    color:inherit;
    text-decoration:none;
  }

  /* ===== サムネイル ===== */
  #csh-{{ section.id }} .csh-thumb{
    border-radius:5px;
    overflow:hidden;
    background:#0b0f14;
  }
  #csh-{{ section.id }} .csh-thumb img{
    width:100%;
    height:auto;
    display:block;
    border-radius:5px;
  }
  #csh-{{ section.id }} .csh-thumb::before{
    content:none !important;
  }

  /* ===== テキスト ===== */
  #csh-{{ section.id }} .csh-body{
    padding:10px 12px 10px 0;
    display:grid;
    gap:6px;
  }
  #csh-{{ section.id }} .csh-name{
    font-size:13px;
    line-height:1.4;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  #csh-{{ section.id }} .csh-price{
    font-size:12px;
    opacity:.9;
  }

  #csh-{{ section.id }} .csh-empty{
    font-size:14px;
    opacity:.8;
  }

  /* ===== SP ===== */
  @media (max-width: 768px){
    #csh-{{ section.id }}{
      position:relative;
    }
    #csh-{{ section.id }} .csh-grid{
      display:flex !important;
      gap: var(--csh-gap-sp);
      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x proximity;
      scroll-snap-stop:normal;
      scrollbar-gutter:stable;
      width: calc(100vw - var(--csh-safe));
      margin-right: calc(50% - 50vw - var(--csh-gap-sp));
      padding-bottom: 72px;
    }
    #csh-{{ section.id }} .csh-card{
      flex:0 0 clamp(140px, 38vw, 240px);
      width: clamp(140px, 38vw, 240px);
      scroll-snap-align:start;
    }
    #csh-{{ section.id }} .csh-grid::after{
      content:"";
      flex: 0 0 calc(max(0px, var(--csh-safe) - var(--csh-gap-sp)));
    }
    #csh-{{ section.id }} .csh-more{
      position:absolute;
      right: var(--csh-safe);
      bottom: 60px;
    }
  }

  /* タブレット（750〜989px）は2列表示 */
  @media (min-width: 750px) and (max-width: 989px){
    #csh-{{ section.id }} .csh-grid{
      display:grid !important;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
  }
  </style>
</section>

{% schema %}
{
  "name": "ブログ記事（Custom）",
  "settings": [
    { "type": "blog", "id": "blog", "label": "ブログを選択" },

    { "type": "range", "id": "limit", "label": "最大表示件数", "min": 1, "max": 12, "step": 1, "default": 4 },

    { "type": "checkbox", "id": "show_excerpt", "label": "抜粋を表示（80文字）", "default": false },

    { "type": "header", "content": "レイアウト" },
    { "type": "range", "id": "columns_desktop", "label": "（PC）列数", "min": 2, "max": 8, "step": 1, "default": 4 },
    { "type": "range", "id": "gap_pc", "label": "（PC）カード間隔(px)", "min": 8, "max": 32, "step": 2, "default": 16 },
    { "type": "range", "id": "gap_sp", "label": "（SP）カード間隔(px)", "min": 6, "max": 24, "step": 1, "default": 12 },

    { "type": "header", "content": "余白 / 背景" },
    { "type": "range", "id": "padding-block-start", "label": "上余白", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 36 },
    { "type": "range", "id": "padding-block-end", "label": "下余白", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 36 },
    { "type": "color", "id": "bg_color", "label": "背景色", "default": "#F5F6F9" },

    { "type": "color_scheme", "id": "color_scheme", "label": "配色（Horizonのスキーム）", "default": "scheme-1" },
    { "type": "color", "id": "accent_color", "label": "アクセントカラー（左線／丸アイコン）", "default": "#E63946" }
  ],
  "presets": [
    { "name": "ブログ記事（Custom）" }
  ]
}
{% endschema %}
