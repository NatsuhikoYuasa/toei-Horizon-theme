

{%- doc -%}
  This block is used to display the accelerated checkout button.
  Intended for product-form.liquid block.

  @param {string} can_add_to_cart - Whether the product can be added to the cart
  @param form_obj - The form object

  @example
  {% content_for 'block', type: 'accelerated-checkout', id: 'accelerated-checkout', can_add_to_cart: can_add_to_cart, form_obj: form %}
{%- enddoc -%}

{% liquid
  assign product = closest.product
  if request.visual_preview_mode and product == blank
    assign product = collections.all.products.first
  endif
%}

<div
  class="accelerated-checkout-block"
  ref="acceleratedCheckoutButtonContainer"
  {{ block.shopify_attributes }}
  {% if request.visual_preview_mode %}
    data-shopify-visual-preview
  {% endif %}
  {% unless can_add_to_cart %}
    hidden
  {% endunless %}
>
  {% if product != blank and form_obj != blank %}
    {{ form_obj | payment_button }}
  {% endif %}
</div>

{% stylesheet %}
  .accelerated-checkout-block[data-shopify-visual-preview] {
    width: 300px;
  }

  more-payment-options-link {
    font-size: smaller;
  }

  more-payment-options-link a {
    --button-color: var(--color-primary);
  }

  more-payment-options-link a:hover {
    --button-color: var(--color-primary-hover);
  }

  .shopify-payment-button__more-options[aria-hidden='true'] {
    display: none;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.accelerated_checkout",
  "tag": null
}
{% endschema %}

{% liquid
  assign variant = product.selected_or_first_available_variant
  assign sell_start_at = variant.metafields.variant.sell_start_at.value
  assign sell_end_at = variant.metafields.variant.sell_end_at.value
%}

<script>
  (function() {
    var sellStartAt = {{ sell_start_at | json }};
    var sellEndAt = {{ sell_end_at | json }};

    if (!sellStartAt && !sellEndAt) return; // 制限なし

    var now = new Date();
    var startTime = sellStartAt ? new Date(sellStartAt) : null;
    var endTime = sellEndAt ? new Date(sellEndAt) : null;

    var isBeforeStart = startTime && now < startTime;
    var isAfterEnd = endTime && now >= endTime;

    if (!isBeforeStart && !isAfterEnd) return; // 期間内なら何もしない

    function disableBuyNowButton() {
      var buttons = document.querySelectorAll('.shopify-payment-button__button, .shopify-payment-button button');
      buttons.forEach(function(btn) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        btn.style.pointerEvents = 'none';
      });
    }

    // 初回実行
    disableBuyNowButton();

    // DOMの変更を監視して、ボタンが追加されたら無効化
    var observer = new MutationObserver(function(mutations) {
      disableBuyNowButton();
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // 念のため一定間隔でも実行
    var interval = setInterval(disableBuyNowButton, 500);

    // 10秒後に監視を停止
    setTimeout(function() {
      observer.disconnect();
      clearInterval(interval);
    }, 10000);
  })();
</script>
