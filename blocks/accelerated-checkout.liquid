

{%- doc -%}
  This block is used to display the accelerated checkout button.
  Intended for product-form.liquid block.

  @param {string} can_add_to_cart - Whether the product can be added to the cart
  @param form_obj - The form object

  @example
  {% content_for 'block', type: 'accelerated-checkout', id: 'accelerated-checkout', can_add_to_cart: can_add_to_cart, form_obj: form %}
{%- enddoc -%}

{% liquid
  assign product = closest.product
  if request.visual_preview_mode and product == blank
    assign product = collections.all.products.first
  endif
%}

<div
  class="accelerated-checkout-block"
  ref="acceleratedCheckoutButtonContainer"
  {{ block.shopify_attributes }}
  {% if request.visual_preview_mode %}
    data-shopify-visual-preview
  {% endif %}
  {% unless can_add_to_cart %}
    hidden
  {% endunless %}
>
  {% if product != blank and form_obj != blank %}
    {{ form_obj | payment_button }}
  {% endif %}
</div>

{% stylesheet %}
  .accelerated-checkout-block[data-shopify-visual-preview] {
    width: 300px;
  }

  more-payment-options-link {
    font-size: smaller;
  }

  more-payment-options-link a {
    --button-color: var(--color-primary);
  }

  more-payment-options-link a:hover {
    --button-color: var(--color-primary-hover);
  }

  .shopify-payment-button__more-options[aria-hidden='true'] {
    display: none;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.accelerated_checkout",
  "tag": null
}
{% endschema %}

<script>
  (function() {
    function updateClientTime() {
      // まずカートの状態を確認
      fetch('/cart.js')
        .then(function(r) { return r.json(); })
        .then(function(cart) {
          // カートに商品がある場合のみ更新
          if (cart.item_count === 0) return;

          var now = new Date();
          var offset = -now.getTimezoneOffset();
          var sign = offset >= 0 ? '+' : '-';
          var hours = String(Math.floor(Math.abs(offset) / 60)).padStart(2, '0');
          var minutes = String(Math.abs(offset) % 60).padStart(2, '0');
          var tz = sign + hours + ':' + minutes;

          var y = now.getFullYear();
          var m = String(now.getMonth() + 1).padStart(2, '0');
          var d = String(now.getDate()).padStart(2, '0');
          var h = String(now.getHours()).padStart(2, '0');
          var min = String(now.getMinutes()).padStart(2, '0');
          var sec = String(now.getSeconds()).padStart(2, '0');

          var clientTime = y + '-' + m + '-' + d + 'T' + h + ':' + min + ':' + sec + tz;

          fetch('/cart/update.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ attributes: { client_current_time: clientTime } })
          });
        });
    }

    // ページ読み込み時に更新
    updateClientTime();

    // 30秒ごとに更新
    setInterval(updateClientTime, 30000);

    // カートに追加された時も更新
    document.addEventListener('cart:updated', updateClientTime);
  })();
</script>
